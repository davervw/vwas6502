
; ******** Source: vwas6502.asm
     1                          ;; vwas6502.asm - interactive console 6502 assembler
     2                          ;;
     3                          ;; >>> STATUS: display/edit memory + run(JMP) + disassembler + assembler <<<
     4                          ;; >>>                     *** MULTIPLATFORM ***                         <<< 
     5                          ;; >>>       ****************************************************        <<< 
     6                          ;; >>>       **           TARGETS:                              *        <<<
     7                          ;; >>>       ** (1)  C64 8000-9FFF screen editor                *        <<<
     8                          ;; >>>       ** (2)  C64 8000-9FFF terminal edition             *        <<<
     9                          ;; >>>       ** (3)  6502+MC6850 minimum system                 *        <<<
    10                          ;; >>>       *   56K(RAM),8K(ROM), 2 bytes IO for MC6850 UART   *        <<<
    11                          ;; >>>       ****************************************************        <<<
    12                          ;;
    13                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    14                          ;; MIT License
    15                          ;;
    16                          ;; Copyright (c) 2024 David R. Van Wagner
    17                          ;; davevw.com
    18                          ;;
    19                          ;; Permission is hereby granted, free of charge, to any person obtaining a copy
    20                          ;; of this software and associated documentation files (the "Software"), to deal
    21                          ;; in the Software without restriction, including without limitation the rights
    22                          ;; to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    23                          ;; copies of the Software, and to permit persons to whom the Software is
    24                          ;; furnished to do so, subject to the following conditions:
    25                          ;;
    26                          ;; The above copyright notice and this permission notice shall be included in all
    27                          ;; copies or substantial portions of the Software.
    28                          ;;
    29                          ;; THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    30                          ;; IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    31                          ;; FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    32                          ;; AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    33                          ;; LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    34                          ;; OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    35                          ;; SOFTWARE.
    36                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    37                          
    38                          ;; DEFINES ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    39                          
    40                          ; Important! define exactly ONE target (set in build.sh)
    41                          ;C64SCREEN = 1
    42                          ;C64TERMINAL = 1
    43                          ;MINIMUM = 1
    44                          
    45                          ; options (set in build.sh)
    46                          ;NEEDECHO = 0
    47                          
    48                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    49                          
    50                          ;; _
    51                          ;; INTERACTIVE SYNTAX >>> display/edit/run, and assemble/disassemble are working <<<
    52                          ;; (WOZMON SIMILAR - note if wozmon present, could leverage existing code)
    53                          ;; 1000 (display memory at $1000)
    54                          ;; 1000.2000 (display memory range $1000 to $2000)
    55                          ;; 1000. (display next screenful of memory starting at $1000)
    56                          ;; . (display next screenful of memory)
    57                          ;; 1000 r (JMP $1000)
    58                          ;; 1000: 01 02 03 (modify memory)
    59                          ;; (NEW SYNTAX)
    60                          ;; 1000 d (disassemble starting at address, for screenful)
    61                          ;; d (continue disassembling from last address)
    62                          ;; 1000 a (assemble starting at, interactive until empty line) 
    63                          ;; x (exit monitor -- C64 only)
    64                          ;; ? (commands help)
    65                          ;; ? a (list instructions available)
    66                          ;; ? adc (assembler addressing modes examples for a specific instruction, replace adc with desired instruction)
    67                          ;; ? mode (show addressing modes example syntax for 6502)
    68                          ;; 1000.2000 "filename" 08 s (C64: save range of bytes from $1000 up to not including $2000, Commodore drive address is optional, defaults to 8)
    69                          ;; (FUTURE SYNTAX, not implemented)
    70                          ;; 1000.2000 "text" ? (search for text in address range inclusive)
    71                          ;; 1000.2000 A9 FF ? (search for byte sequence in address range inclusive)
    72                          ;; 1000.2000 3000 m (move bytes $1000-$2000 inclusive to $3000, left/right move as appropriate)
    73                          ;; 1000.2000: 01 02 03 (fill bytes to inclusive address range)
    74                          ;; .? (display registers, VICE format or custom? screen editor changeable?)
    75                          ;; .A: 00 (change register, replace A with X, Y, SP, S, PC, SR, P, N, V, B, D, I, Z, C as appropriate, colon is optional)
    76                          ;; 1000 "filename" 08 load (load absolute, address optional, drive address is optional, can abbreviate to l)
    77                          ;;
    78                          ;; (INTERACTIVE ASSEMBLER)
    79                          ;; 1000 _
    80                          ;;      ADC #$12
    81                          ;; 1000 69 12    ADC #$12
    82                          ;; 1002 _
    83                          ;;      JSR $1234
    84                          ;; 1002 20 34 12 JSR $1234
    85                          ;; 1005 _
    86                          ;;      RTS
    87                          ;; 1005 60       RTS
    88                          ;; 1006 _
    89                          ;;      XYZ
    90                          ;;      XYZ ?
    91                          ;; 1006 _
    92                          ;; _
    93                          ;;
    94                          ;; line editor version (Commodore) can revise address, and can overwrite input line with results of assembly
    95                          ;; and can cursor up to revise, 
    96                          ;;
    97                          ;; can also assume assembler mode on the fly regardless if line editor or raw terminal if see instruction name after address, so a command is superfluous
    98                          ;;
    99                          
   100                          ; global
   101                          inputbuf=$0200
   102                          
   103                          
   104                          ; kernal/system calls
   105                          
   106                          !ifdef MINIMUM {
   107                          charout=JUART_OUT
   108                          getkey=JUART_IN
   109                          }
   110                          
   111                          !ifdef C64SCREEN {
   112                          setlfs=$ffba
   113                          setnam=$ffbd
   114                          charin=$ffcf ; screen editor
   115                          charout=$ffd2
   116                          fsave =$ffd8
   117                          getkey=$ffe4
   118                          }
   119                          
   120                          !ifdef C64TERMINAL {
   121                          setlfs=$ffba
   122                          setnam=$ffbd
   123                          charout=$ffd2
   124                          getkey=$ffe4
   125                          fsave =$ffd8
   126                          }
   127                          
   128                          ; zeropage
   129                          !ifdef MINIMUM {
   130                          opidx=$f0
   131                          inidx=$f1
   132                          mode=$f2
   133                          size=$f3
   134                          ptr3=$f4 ; and $f5
   135                          count=$f6
   136                          len=$f7
   137                          savepos=$f8
   138                          tmp2=$f9
   139                          flag=$fa
   140                          ptr1=$fb ; and $fc
   141                          ptr2=$fd ; and $fe
   142                          tmp=$ff
   143                          } else {
   144                          opidx=$22
   145                          inidx=$23
   146                          mode=$24
   147                          size=$25
   148                          ptr3=$26 ; and $27
   149                          count=$a3
   150                          len=$a4
   151                          savepos=$a5
   152                          tmp2=$a6
   153                          flag=$a7
   154                          ptr1=$fb ; and $fc
   155                          ptr2=$fd ; and $fe
   156                          tmp=$ff
   157                          }
   158                          
   159                          !ifdef MINIMUM {
   160                          * = $e000
   161                          } else { // any C64
   162                          * = $8000
   163                              ; check if irq/brk vector installed
   164  8000 ad1603                 lda $316
   165  8003 ae1703                 ldx $317
   166  8006 e08c                   cpx #>brk64
   167  8008 f010                   beq +
   168  800a 8d8c92                 sta savebrkvector
   169  800d 8e8d92                 stx savebrkvector+1
   170  8010 a90f                   lda #<brk64
   171  8012 a28c                   ldx #>brk64
   172  8014 8d1603                 sta $316
   173  8017 8e1703                 stx $317
   174  801a 203980             +   jsr install_nmi64   
   175                          }
   176                          
   177                          start:
   178  801d d8                     cld
   179  801e 58                     cli
   180  801f a9bd                   lda #<copyright
   181  8021 a28f                   ldx #>copyright
   182  8023 20c383                 jsr strout
   183  8026 a91b                   lda #<firsthelp
   184  8028 a290                   ldx #>firsthelp
   185  802a 20c383                 jsr strout
   186  802d 4c348b                 jmp save_regs_and_stack
   187                          
   188                          input_loop:
   189  8030 20de83                 jsr inputline
   190  8033 20e183                 jsr parseline
   191  8036 4c3080                 jmp input_loop
   192                          
   193                          !ifndef MINIMUM {
   194                          ; C64 only
   195                          
   196                          install_nmi64:
   197                              ; check if nmi vector installed
   198  8039 ad1803                 lda $318
   199  803c ae1903                 ldx $319
   200  803f e08b                   cpx #>nmi64
   201  8041 f010                   beq +
   202  8043 8d8e92                 sta savenmivector
   203  8046 8e8f92                 stx savenmivector+1
   204  8049 a9f0                   lda #<nmi64
   205  804b a28b                   ldx #>nmi64
   206  804d 8d1803                 sta $318
   207  8050 8e1903                 stx $319
   208  8053 60                 +   rts
   209                          
   210                          uninstall_nmi64:
   211  8054 ad8e92                 lda savenmivector
   212  8057 ae8f92                 ldx savenmivector+1
   213  805a 8d1803                 sta $318
   214  805d 8e1903                 stx $319
   215  8060 60                     rts
   216                          
   217                          chkextrac64:
   218  8061 206d80                 jsr chkexit
   219  8064 d003                   bne +
   220  8066 4c8180                 jmp execute_exit
   221  8069 18                 +   clc ; no error
   222  806a a201                   ldx #1 ; Z false - not consumed
   223  806c 60                     rts
   224                          
   225                          chkexit:
   226  806d b90002                 lda inputbuf, y
   227  8070 c958                   cmp #'X'
   228  8072 d008                   bne +
   229  8074 c8                     iny
   230  8075 c4a4                   cpy len ; validate no extra characters
   231  8077 f003                   beq +
   232  8079 4c7d80                 jmp extra_error
   233  807c 60                 +   rts
   234                          
   235                          extra_error:
   236                              ; pop local return address
   237  807d 68                     pla
   238  807e 68                     pla
   239  807f 38                     sec ; error
   240  8080 60                     rts
   241                          
   242                          execute_exit:
   243  8081 ad8c92                 lda savebrkvector
   244  8084 ae8d92                 ldx savebrkvector+1
   245  8087 8d1603                 sta $316
   246  808a 8e1703                 stx $317
   247  808d 205480                 jsr uninstall_nmi64
   248                              ; pop monitor return addresses, so only original caller is left
   249  8090 68                     pla
   250  8091 68                     pla
   251  8092 68                     pla
   252  8093 68                     pla
   253  8094 68                     pla
   254  8095 68                     pla
   255  8096 60                     rts
   256                          
   257                          display_extra_help:
   258  8097 a92e                   lda #<extra_help
   259  8099 a290                   ldx #>extra_help
   260  809b 4cc383                 jmp strout
   261                          
   262                          !ifdef C64SCREEN {
   263                          display_page_disassemble:
   264  809e a5fb                   lda ptr1
   265  80a0 a6fc                   ldx ptr1+1
   266  80a2 204783                 jsr disphexword
   267  80a5 a96c                   lda #<page_disassemble
   268  80a7 a290                   ldx #>page_disassemble
   269  80a9 4cc383                 jmp strout
   270                          
   271                          display_page_displaymemory:
   272  80ac 202a8b                 jsr newline
   273  80af a5fb                   lda ptr1
   274  80b1 a6fc                   ldx ptr1+1
   275  80b3 204783                 jsr disphexword
   276  80b6 a973                   lda #<page_displaymemory
   277  80b8 a290                   ldx #>page_displaymemory
   278  80ba 4cc383                 jmp strout
   279                          
   280                          inputlinec64:
   281  80bd a000                   ldy #0
   282  80bf 20cfff             -   jsr charin
   283  80c2 990002                 sta inputbuf,y
   284  80c5 c8                     iny
   285  80c6 c90d                   cmp #13
   286  80c8 d0f5                   bne -
   287  80ca 60                     rts
   288                          
   289                          continueassemblec64:
   290  80cb a914                   lda #20
   291  80cd 20d2ff                 jsr charout
   292  80d0 20d2ff                 jsr charout
   293  80d3 a5fb                   lda ptr1
   294  80d5 a6fc                   ldx ptr1+1
   295  80d7 204783                 jsr disphexword
   296  80da a920                   lda #' '
   297  80dc 20d2ff                 jsr charout
   298  80df 20d2ff                 jsr charout
   299  80e2 4cd2ff                 jmp charout
   300                          }
   301                          
   302                          chkfilename:
   303  80e5 20838a                 jsr skipspaces
   304  80e8 84ff                   sty tmp
   305  80ea b90002                 lda inputbuf, y
   306  80ed c922                   cmp #34 ; double quote
   307  80ef d022                   bne ++
   308  80f1 c8                 -   iny
   309  80f2 b90002                 lda inputbuf, y
   310  80f5 c90d                   cmp #13
   311  80f7 d004                   bne +
   312  80f9 a4ff                   ldy tmp
   313  80fb d016                   bne ++
   314  80fd c922               +   cmp #34 ; double quote
   315  80ff d0f0                   bne -
   316  8101 98                     tya ; index of ending double quotes
   317  8102 48                     pha ; save
   318  8103 18                     clc ; will subtract one more
   319  8104 e5ff                   sbc tmp ; subtract index of first quote, have filename length
   320  8106 a6ff                   ldx tmp
   321  8108 e8                     inx ; low address of filename
   322  8109 a002                   ldy #>inputbuf ; high address of filename
   323  810b 20bdff                 jsr setnam
   324  810e 68                     pla
   325  810f a8                     tay
   326  8110 c8                     iny ; advance past ending double quotes
   327  8111 a900                   lda #0 ; set Z true
   328  8113 60                 ++  rts
   329                          
   330                          check_execute_save:
   331  8114 20e580             +   jsr chkfilename
   332  8117 f006                   beq +
   333  8119 206c8a                 jsr reporterr
   334  811c a201                   ldx #1 ; set Z false
   335  811e 60                     rts
   336  811f 202d81             +   jsr chkoptionaldrive
   337  8122 204381                 jsr chksave
   338  8125 d005                   bne +
   339  8127 204c81                 jsr executesave
   340  812a a200                   ldx #0 ; set Z true
   341  812c 60                 +   rts
   342                          
   343                          chkoptionaldrive:
   344  812d a908                   lda #8
   345  812f 8d9092                 sta drive
   346  8132 20838a                 jsr skipspaces
   347  8135 20d68a                 jsr chkhexbyte
   348  8138 d008                   bne +
   349  813a 8d9092                 sta drive
   350  813d 20838a                 jsr skipspaces
   351  8140 a900                   lda #0 ; set Z true
   352  8142 60                 +   rts
   353                          
   354                          chksave:
   355  8143 20838a                 jsr skipspaces
   356  8146 b90002                 lda inputbuf, y
   357  8149 c953                   cmp #'S'
   358  814b 60                     rts
   359                          
   360                          executesave:
   361  814c 202a8b                 jsr newline
   362  814f a9c0                   lda #$c0 ; KERNAL control and error messages
   363  8151 859d                   sta $9d ; set messages to be displayed
   364  8153 a901                   lda #1
   365  8155 ae9092                 ldx drive
   366  8158 a00f                   ldy #15
   367  815a 20baff                 jsr setlfs
   368  815d a9fb                   lda #ptr1
   369  815f a6fd                   ldx ptr2
   370  8161 a4fe                   ldy ptr2+1
   371  8163 20d8ff                 jsr fsave
   372  8166 4c2a8b                 jmp newline
   373                          }
   374                          
   375                          ; test: ; all the addressing modes here for testing disassembly
   376                          ;     nop
   377                          ;     lda $1234
   378                          ;     lda $1234,x
   379                          ;     lda $1234,y
   380                          ;     asl
   381                          ;     lda #$12
   382                          ;     lda ($12,x)
   383                          ;     lda ($12),y
   384                          ;     jmp ($1234)
   385                          ; -   bne -
   386                          ;     lda $12
   387                          ;     lda $12,x
   388                          ;     ldx $12,y
   389                          ;     !byte $FF ; unknown
   390                          
   391                          disassemble:
   392  8169 a917                   lda #23
   393  816b 85a3                   sta count
   394  816d a000               -   ldy #0
   395  816f b1fb                   lda (ptr1),y
   396  8171 209881                 jsr find_opcode
   397  8174 20fb81                 jsr disp_current
   398  8177 a525                   lda size
   399  8179 1002                   bpl +
   400  817b a901                   lda #1
   401  817d 18                 +   clc
   402  817e 65fb                   adc ptr1
   403  8180 85fb                   sta ptr1
   404  8182 9002                   bcc +
   405  8184 e6fc                   inc ptr1+1
   406  8186 c6a3               +   dec count
   407  8188 d0e3                   bne -
   408                          !ifdef C64SCREEN {
   409  818a 4c9e80                 jmp display_page_disassemble
   410                          } else {    
   411                              rts
   412                          }
   413                          
   414                          compareptrs:
   415  818d a5fc                   lda ptr1+1
   416  818f c5fe                   cmp ptr2+1
   417  8191 d004                   bne +
   418  8193 a5fb                   lda ptr1
   419  8195 c5fd                   cmp ptr2
   420  8197 60                 +   rts
   421                          
   422                          find_opcode: ; INPUT: .A opcode byte, OUTPUT: C flag set if found, .A instruction index, .X opcode index, .Y mode, otherwise C clear, and .A/.X/.Y all $FF
   423                          ; and properties updated in ZP globals size,inidx,opidx,mode
   424  8198 a097                   ldy #nopcodes
   425  819a a296                   ldx #nopcodes-1
   426  819c ddf88d             -   cmp opcodes,x
   427  819f f00f                   beq +
   428  81a1 ca                     dex
   429  81a2 88                     dey
   430  81a3 d0f7                   bne -
   431  81a5 18                     clc
   432  81a6 a901                   lda #1
   433  81a8 8525                   sta size
   434  81aa a9ff                   lda #$FF
   435  81ac aa                     tax
   436  81ad a8                     tay
   437  81ae 900a                   bcc ++
   438  81b0 bd8f8e             +   lda instidx, x
   439  81b3 bc268f                 ldy modeidx, x
   440  81b6 20c181                 jsr getsize
   441  81b9 38                     sec
   442  81ba 8523               ++  sta inidx
   443  81bc 8622                   stx opidx
   444  81be 8424                   sty mode
   445  81c0 60                     rts
   446                          
   447                          getsize: ; y is addressing mode index (0..12), registers untouched except status
   448                              ; result returned in size
   449  81c1 48                     pha
   450  81c2 a901                   lda #1
   451  81c4 8525                   sta size
   452  81c6 68                     pla
   453  81c7 c002                   cpy #2 // Immediate
   454  81c9 9008                   bcc +
   455  81cb e625                   inc size
   456  81cd c009                   cpy #9 // Absolute
   457  81cf 9002                   bcc +
   458  81d1 e625                   inc size
   459  81d3 60                 +   rts
   460                          
   461                          disp_opcode: ; .A opcode byte
   462  81d4 209881                 jsr find_opcode
   463  81d7 8a                     txa
   464                              ; fall through to display instruction
   465                          
   466                          dispinst: ; .A instruction index 0..55, note modifies A and X
   467  81d8 aa                     tax
   468  81d9 e038                   cpx #ninst
   469  81db b012                   bcs +
   470  81dd bd378c                 lda inst0, x
   471  81e0 20d2ff                 jsr charout
   472  81e3 bd6f8c                 lda inst1, x
   473  81e6 20d2ff                 jsr charout
   474  81e9 bda78c                 lda inst2, x
   475  81ec 4cd2ff                 jmp charout
   476  81ef a93f               +   lda #'?'
   477  81f1 20d2ff                 jsr charout
   478  81f4 20d2ff                 jsr charout
   479  81f7 20d2ff                 jsr charout
   480  81fa 60                     rts
   481                          
   482                          disp_current:
   483  81fb a5fb                   lda ptr1
   484  81fd a6fc                   ldx ptr1+1
   485  81ff 204783                 jsr disphexword
   486  8202 a920                   lda #$20
   487  8204 20d2ff                 jsr charout
   488  8207 a000                   ldy #0
   489  8209 a625                   ldx size
   490  820b b1fb               -   lda (ptr1),y
   491  820d 204d83                 jsr disphexbyte
   492  8210 a920                   lda #$20
   493  8212 20d2ff                 jsr charout
   494  8215 c8                     iny
   495  8216 ca                     dex
   496  8217 d0f2                   bne -
   497  8219 c003               -   cpy #3
   498  821b f00e                   beq +
   499  821d a920                   lda #$20
   500  821f 20d2ff                 jsr charout
   501  8222 20d2ff                 jsr charout
   502  8225 20d2ff                 jsr charout
   503  8228 c8                     iny
   504  8229 d0ee                   bne -
   505  822b a523               +   lda inidx
   506  822d 20d881                 jsr dispinst
   507  8230 a920                   lda #$20
   508  8232 20d2ff                 jsr charout
   509  8235 203d82                 jsr disp_mode
   510  8238 a90d                   lda #13
   511  823a 4cd2ff                 jmp charout
   512                          
   513                          disp_mode
   514  823d a524                   lda mode
   515  823f c90d                   cmp #13
   516  8241 b00a                   bcs +
   517  8243 0a                     asl
   518  8244 aa                     tax
   519  8245 bde08c                 lda mode_jmptable+1,x
   520  8248 48                     pha
   521  8249 bddf8c                 lda mode_jmptable,x
   522  824c 48                     pha
   523  824d 60                 +   rts
   524                          
   525                          dispModeAcc:
   526  824e a941                   lda #'A'
   527  8250 4cd2ff                 jmp charout
   528                          
   529                          dispModeNone:
   530  8253 60                     rts
   531                          
   532                          dispModeImm:
   533  8254 a923                   lda #'#'
   534  8256 20d2ff                 jsr charout
   535                          dispModeZP:
   536  8259 a924                   lda #'$'
   537  825b 20d2ff                 jsr charout
   538  825e a001                   ldy #1
   539  8260 b1fb                   lda (ptr1),y
   540  8262 4c4d83                 jmp disphexbyte
   541                          
   542                          dispModeIndX:
   543  8265 a928                   lda #'('
   544  8267 20d2ff                 jsr charout
   545  826a a924                   lda #'$'
   546  826c 20d2ff                 jsr charout
   547  826f a001                   ldy #1
   548  8271 b1fb                   lda (ptr1),y
   549  8273 204d83                 jsr disphexbyte
   550  8276 a92c                   lda #','
   551  8278 20d2ff                 jsr charout
   552  827b a958                   lda #'X'
   553  827d 20d2ff                 jsr charout
   554  8280 a929                   lda #')'
   555  8282 4cd2ff                 jmp charout
   556                          
   557                          dispModeIndY:
   558  8285 a928                   lda #'('
   559  8287 20d2ff                 jsr charout
   560  828a a924                   lda #'$'
   561  828c 20d2ff                 jsr charout
   562  828f a001                   ldy #1
   563  8291 b1fb                   lda (ptr1),y
   564  8293 204d83                 jsr disphexbyte
   565  8296 a929                   lda #')'
   566  8298 20d2ff                 jsr charout
   567  829b a92c                   lda #','
   568  829d 20d2ff                 jsr charout
   569  82a0 a959                   lda #'Y'
   570  82a2 4cd2ff                 jmp charout
   571                          
   572                          dispModeRel:
   573  82a5 a924                   lda #'$'
   574  82a7 20d2ff                 jsr charout
   575  82aa 18                     clc
   576  82ab a5fb                   lda ptr1
   577  82ad 6902                   adc #2
   578  82af 8526                   sta ptr3
   579  82b1 a5fc                   lda ptr1+1
   580  82b3 6900                   adc #0
   581  82b5 8527                   sta ptr3+1
   582  82b7 a001                   ldy #1
   583  82b9 b1fb                   lda (ptr1),y
   584  82bb 1014                   bpl +
   585                              ; I'm not sure how to successfully navigate page boundries adding signed byte to unsigned byte, so I'm subtracting unsigned bytes instead
   586  82bd 49ff                   eor #$FF ; inverse
   587  82bf 18                     clc
   588  82c0 6901                   adc #1 ; complete getting absolute value from two's complement
   589  82c2 85ff                   sta tmp
   590  82c4 38                     sec
   591  82c5 a526                   lda ptr3
   592  82c7 e5ff                   sbc tmp
   593  82c9 8526                   sta ptr3
   594  82cb b00d                   bcs ++
   595  82cd c627                   dec ptr3+1
   596  82cf 9009                   bcc ++
   597  82d1 18                 +   clc ; simple case of adding
   598  82d2 6526                   adc ptr3
   599  82d4 8526                   sta ptr3
   600  82d6 9002                   bcc ++
   601  82d8 e627                   inc ptr3+1
   602  82da a526               ++  lda ptr3
   603  82dc a627                   ldx ptr3+1
   604  82de 4c4783                 jmp disphexword
   605                          
   606                          dispModeZPX:
   607  82e1 205982                 jsr dispModeZP
   608  82e4 a92c                   lda #','
   609  82e6 20d2ff                 jsr charout
   610  82e9 a958                   lda #'X'
   611  82eb 4cd2ff                 jmp charout
   612                          
   613                          dispModeZPY:
   614  82ee 205982                 jsr dispModeZP
   615  82f1 a92c                   lda #','
   616  82f3 20d2ff                 jsr charout
   617  82f6 a959                   lda #'Y'
   618  82f8 4cd2ff                 jmp charout
   619                          
   620                          dispModeAbs:
   621  82fb a924                   lda #'$'
   622  82fd 20d2ff                 jsr charout
   623  8300 a001                   ldy #1
   624  8302 b1fb                   lda (ptr1),y
   625  8304 48                     pha
   626  8305 c8                     iny
   627  8306 b1fb                   lda (ptr1),y
   628  8308 aa                     tax
   629  8309 68                     pla
   630  830a 4c4783                 jmp disphexword
   631                          
   632                          dispModeAbsX:
   633  830d 20fb82                 jsr dispModeAbs
   634  8310 a92c                   lda #','
   635  8312 20d2ff                 jsr charout
   636  8315 a958                   lda #'X'
   637  8317 4cd2ff                 jmp charout
   638                          
   639                          dispModeAbsY:
   640  831a 20fb82                 jsr dispModeAbs
   641  831d a92c                   lda #','
   642  831f 20d2ff                 jsr charout
   643  8322 a959                   lda #'Y'
   644  8324 4cd2ff                 jmp charout
   645                          
   646                          dispModeInd:
   647  8327 a928                   lda #'('
   648  8329 20d2ff                 jsr charout
   649  832c 20fb82                 jsr dispModeAbs
   650  832f a929                   lda #')'
   651  8331 4cd2ff                 jmp charout
   652                          
   653                          dispbinbyte: ; .A 00..FF
   654  8334 a208                   ldx #8
   655  8336 85ff                   sta tmp
   656  8338 a930               -   lda #'0'
   657  833a 26ff                   rol tmp
   658  833c 9002                   bcc +
   659  833e a931                   lda #'1'
   660  8340 20d2ff             +   jsr charout
   661  8343 ca                     dex
   662  8344 d0f2                   bne -
   663  8346 60                     rts
   664                          
   665                          disphexword: ; .A low, .X high, 0000..FFFF
   666  8347 48                     pha
   667  8348 8a                     txa
   668  8349 204d83                 jsr disphexbyte
   669  834c 68                     pla
   670                              ;fall through to call again
   671                          
   672                          disphexbyte: ; .A 00..FF
   673  834d 48                     pha
   674  834e 4a                     lsr
   675  834f 4a                     lsr
   676  8350 4a                     lsr
   677  8351 4a                     lsr
   678  8352 205683                 jsr disphexnybble
   679  8355 68                     pla
   680                              ;fall through to call again
   681                          
   682                          disphexnybble: ; .A 0..F
   683  8356 290f                   and #$0F
   684  8358 0930                   ora #$30
   685  835a c93a                   cmp #$3A
   686  835c 9002                   bcc +
   687  835e 6906                   adc #$06
   688  8360 4cd2ff             +   jmp charout
   689                          
   690                          inputhexword: ; C set if fails
   691  8363 a900                   lda #0
   692  8365 85fb                   sta ptr1
   693  8367 85fc                   sta ptr1+1
   694                          
   695  8369 a904                   lda #4 ; word is at most 4 nybbles
   696  836b 85a3                   sta count
   697  836d 20a583             --  jsr inputhexnybble
   698  8370 b012                   bcs +
   699                          
   700                              ; shift nibble up
   701  8372 0a                     asl
   702  8373 0a                     asl
   703  8374 0a                     asl
   704  8375 0a                     asl
   705                          
   706  8376 a204                   ldx #4 ; 4 bits rotated into word
   707  8378 2a                 -   rol
   708  8379 26fb                   rol ptr1
   709  837b 26fc                   rol ptr1+1
   710  837d ca                     dex
   711  837e d0f8                   bne - ; repeat bits
   712                          
   713  8380 c6a3                   dec count
   714  8382 d0e9                   bne -- ; repeat nybbles
   715                          
   716  8384 a5a3               +   lda count
   717  8386 c904                   cmp #4 ; set C if 4, otherwise clear
   718  8388 60                     rts
   719                          
   720                          inputhexbyte:
   721  8389 20a583                 jsr inputhexnybble
   722  838c b016                   bcs ++
   723  838e 85ff                   sta tmp
   724  8390 20a583                 jsr inputhexnybble
   725  8393 9005                   bcc +
   726  8395 18                     clc ; allow single digit as byte
   727  8396 a5ff                   lda tmp
   728  8398 900a                   bcc ++
   729  839a 06ff               +   asl tmp
   730  839c 06ff                   asl tmp
   731  839e 06ff                   asl tmp
   732  83a0 06ff                   asl tmp
   733  83a2 05ff                   ora tmp ; necessary to assemble the two nybbles
   734  83a4 60                 ++  rts
   735                          
   736                          inputhexnybble:
   737  83a5 b90002                 lda $0200,y
   738  83a8 297f                   and #$7F
   739  83aa 38                     sec
   740  83ab e930                   sbc #$30
   741  83ad 9012                   bcc ++
   742  83af c90a                   cmp #10
   743  83b1 900c                   bcc +
   744  83b3 e907                   sbc #7
   745  83b5 900a                   bcc ++
   746  83b7 c90a                   cmp #10
   747  83b9 9006                   bcc ++
   748  83bb c910                   cmp #16
   749  83bd b002                   bcs ++
   750  83bf c8                 +   iny
   751  83c0 60                     rts
   752  83c1 38                 ++  sec
   753  83c2 60                     rts
   754                          
   755                          strout:
   756  83c3 8526                   sta ptr3
   757  83c5 8627                   stx ptr3+1
   758                          strout2:    
   759  83c7 a000                   ldy #0
   760  83c9 b126               -   lda (ptr3),y
   761  83cb f006                   beq +
   762  83cd 20d2ff                 jsr charout
   763  83d0 c8                     iny
   764  83d1 d0f6                   bne -
   765  83d3 98                 +   tya
   766  83d4 38                     sec
   767  83d5 6526                   adc ptr3
   768  83d7 8526                   sta ptr3
   769  83d9 9002                   bcc +
   770  83db e627                   inc ptr3+1
   771  83dd 60                 +   rts
   772                          
   773                          inputline:
   774                          !ifdef C64SCREEN {
   775  83de 4cbd80                 jmp inputlinec64
   776                          } else {
   777                              ldy #0
   778                          --  sty count
   779                          -   jsr getkey
   780                              beq -
   781                              ldy count
   782                          !ifdef MINIMUM {
   783                              cmp #8 ; backspace
   784                          } else {
   785                              cmp #20
   786                          }
   787                              bne +
   788                              cpy #0
   789                              beq -
   790                              dey
   791                          !if NEEDECHO = 1 {    
   792                              jsr charout
   793                          }
   794                              jmp --
   795                          +   cmp #13
   796                              beq +
   797                              cmp #' '
   798                              bcc -
   799                              cmp #128
   800                              bcs -
   801                          +
   802                          !if NEEDECHO = 1 {    
   803                              jsr charout
   804                          }
   805                              sta inputbuf,y
   806                              iny
   807                              cmp #13
   808                              bne --
   809                              rts
   810                          }
   811                          
   812                          parseline:
   813  83e1 c001                   cpy #1
   814  83e3 d003                   bne +
   815                          -
   816                          !ifdef C64SCREEN {   
   817  83e5 4c2a8b                 jmp newline
   818                          } else {
   819                              rts
   820                          }
   821  83e8 88                 +   dey
   822  83e9 84a4                   sty len
   823                              ; skip whitespace
   824                              ; check for address, put in ptr1
   825                              ; or check for dot, then require address put in ptr2
   826                              ; or check for ?, and optional parameter, execute help
   827                              ; check for whitespace
   828                              ; check for address, put in ptr3, check if is byte sequence, store at start of inputbuf instead
   829                              ; check for string, store at start of inputbuf
   830                              ; check for drive number
   831                              ; check for whitespace
   832                              ; check command ":rda?mls", execute command
   833  83eb a000                   ldy #0
   834  83ed 20838a                 jsr skipspaces
   835  83f0 c4a4                   cpy len
   836  83f2 f0f1                   beq -
   837  83f4 20398a                 jsr chkcontinuedis
   838  83f7 d003                   bne +
   839  83f9 205d8a                 jsr executedisassemble ; note won't return
   840  83fc 204b8a             +   jsr chkcontinueasm
   841  83ff d003                   bne +
   842  8401 206e86                 jsr continueassemble ; note won't return
   843  8404 20928a             +   jsr chkdot
   844  8407 d003                   bne +
   845  8409 4cf084                 jmp executedot
   846  840c 209d8a             +   jsr chkhelp
   847  840f d003                   bne +
   848  8411 4cfa84                 jmp executehelp
   849                          +
   850                          !ifndef MINIMUM {
   851  8414 206180                 jsr chkextrac64 ; check syntax only available on C64
   852  8417 b014                   bcs + ; error if C set
   853  8419 f005                   beq ++ ; consumed if Z set, skip next test(s)
   854                          }    
   855  841b 20cd8a                 jsr chkhexaddr1
   856  841e d003                   bne error
   857  8420 4c2684             ++  jmp executeaddr1
   858                          error:
   859  8423 4c6c8a                 jmp reporterr
   860                          
   861                          executeaddr1:
   862  8426 c4a4                   cpy len
   863  8428 d003                   bne +
   864  842a 4c7f84                 jmp executedisplay1
   865  842d 20928a             +   jsr chkdot
   866  8430 d00f                   bne +
   867  8432 c4a4                   cpy len
   868  8434 f021                   beq executepagedisplay
   869  8436 20ed8a                 jsr chkhexaddr2
   870  8439 d0e8                   bne error
   871  843b 18                     clc
   872  843c 66a7                   ror flag
   873  843e 4c6f84                 jmp executeaddr12
   874  8441 20838a             +   jsr skipspaces
   875  8444 20a88a                 jsr chkcolon
   876  8447 d003                   bne +
   877  8449 4cce84                 jmp executemodify
   878  844c 200e8b             +   jsr chkaddr1cmd ; r/d/a, will not return here if cmd
   879                          !ifdef MINIMUM {
   880                              jmp reportnotimplemented
   881                          } else {
   882  844f 20e580                 jsr chkfilename
   883  8452 d0cf                   bne error
   884  8454 4cf784                 jmp executeloadfilename
   885                          }
   886                          
   887                          executepagedisplay:
   888  8457 a5fb                   lda ptr1
   889  8459 18                     clc
   890                          !ifdef MINIMUM {
   891                              adc #$5f
   892                          } else {
   893  845a 69b7                   adc #$b7
   894                          }
   895  845c 85fd                   sta ptr2
   896  845e a5fc                   lda ptr1+1
   897                          !ifdef MINIMUM {
   898                              adc #$01
   899                          } else {
   900  8460 6900                   adc #$00
   901                          }
   902  8462 85fe                   sta ptr2+1
   903  8464 9006                   bcc +
   904  8466 a9ff                   lda #$ff
   905  8468 85fd                   sta ptr2
   906  846a 85fe                   sta ptr2+1
   907  846c 38                 +   sec
   908  846d 66a7                   ror flag
   909                              ; fall through to executeaddr12
   910                          
   911                          executeaddr12:
   912  846f c4a4                   cpy len
   913  8471 d003                   bne +
   914  8473 4c8784                 jmp executedisplay12
   915                          !ifndef MINIMUM { // any C64
   916  8476 201481             +   jsr check_execute_save
   917  8479 f003                   beq ++
   918                          }
   919  847b 4c658a             +   jmp reportnotimplemented
   920  847e 60                 ++  rts
   921                          
   922                          executedisplay1:
   923  847f a5fb                   lda ptr1
   924  8481 85fd                   sta ptr2
   925  8483 a5fc                   lda ptr1+1
   926  8485 85fe                   sta ptr2+1
   927                              ; fall through executedisplay12
   928                          
   929                          executedisplay12:
   930  8487 a9ff                   lda #$ff
   931  8489 85a3                   sta count
   932  848b e6a3               -   inc count
   933  848d a5a3                   lda count
   934                          !ifdef MINIMUM {    
   935                              and #$0f
   936                          } else {
   937  848f 2907                   and #$07
   938                          }
   939  8491 d016                   bne +
   940  8493 a90d                   lda #13
   941  8495 20d2ff                 jsr charout
   942  8498 a5fb                   lda ptr1
   943  849a a6fc                   ldx ptr1+1
   944  849c 204783                 jsr disphexword
   945  849f a93a                   lda #':'
   946  84a1 20d2ff                 jsr charout
   947  84a4 a920                   lda #' '
   948  84a6 20d2ff                 jsr charout
   949  84a9 a000               +   ldy #0
   950  84ab b1fb                   lda (ptr1),y
   951  84ad 204d83                 jsr disphexbyte
   952  84b0 a920                   lda #' '
   953  84b2 20d2ff                 jsr charout
   954  84b5 e6fb                   inc ptr1
   955  84b7 d004                   bne +
   956  84b9 e6fc                   inc ptr1+1
   957  84bb f00e                   beq ++
   958  84bd 208d81             +   jsr compareptrs
   959  84c0 90c9                   bcc -
   960  84c2 f0c7                   beq -
   961  84c4 24a7                   bit flag
   962  84c6 1003                   bpl ++
   963                          !ifdef C64SCREEN {
   964  84c8 4cac80                 jmp display_page_displaymemory
   965                          }
   966  84cb 4c2a8b             ++  jmp newline
   967                          
   968                          executemodify:
   969  84ce 20838a                 jsr skipspaces
   970  84d1 c4a4                   cpy len
   971  84d3 f018                   beq ++
   972  84d5 20b38a                 jsr chkhexbyteofsequence
   973  84d8 f003                   beq +
   974  84da 4c2384                 jmp error
   975  84dd 84ff               +   sty tmp
   976  84df a000                   ldy #0
   977  84e1 91fb                   sta (ptr1),y
   978  84e3 e6fb                   inc ptr1
   979  84e5 d002                   bne +
   980  84e7 e6fc                   inc ptr1+1
   981  84e9 a4ff               +   ldy tmp
   982  84eb d0e1                   bne executemodify
   983  84ed 4c2a8b             ++  jmp newline
   984                          
   985                          executedot:
   986  84f0 c4a4                   cpy len
   987  84f2 d003                   bne +
   988  84f4 4c5784                 jmp executepagedisplay
   989                          
   990                          executeloadfilename:
   991                          executeaddr1cmd:
   992  84f7 4c658a             +   jmp reportnotimplemented
   993                          
   994                          executehelp:
   995                          !ifdef C64SCREEN {
   996  84fa 202a8b                 jsr newline
   997                          }
   998  84fd c4a4                   cpy len
   999  84ff d003                   bne +
  1000  8501 4c2a85                 jmp displayhelp
  1001  8504 20838a             +   jsr skipspaces
  1002  8507 203e85                 jsr chkhelpinstructions
  1003  850a d003                   bne +
  1004  850c 4c7a85                 jmp displayinstructions
  1005  850f 205885             +   jsr chkhelpmodes
  1006  8512 d003                   bne +
  1007  8514 4c9185                 jmp displaymodes
  1008  8517 20a889             +   jsr chkinstruction
  1009  851a d003                   bne +
  1010  851c 4c4186                 jmp executehelpinstruction
  1011  851f 204b85             +   jsr chkhelpregisters
  1012  8522 d003                   bne +
  1013  8524 4c808b                 jmp execute_display_registers
  1014  8527 4c658a             +   jmp reportnotimplemented
  1015                          
  1016                          displayhelp:
  1017  852a a98b                   lda #<generalhelp
  1018  852c a290                   ldx #>generalhelp
  1019  852e 20c383                 jsr strout
  1020  8531 a980                   lda #<generalhelp2
  1021  8533 a291                   ldx #>generalhelp2
  1022  8535 20c383                 jsr strout
  1023                          !ifndef MINIMUM { // any C64
  1024  8538 209780                 jsr display_extra_help
  1025                          }
  1026  853b 4c2a8b                 jmp newline
  1027                          
  1028                          chkhelpinstructions:
  1029  853e b90002                 lda inputbuf, y
  1030  8541 c941                   cmp #'A'
  1031  8543 d005                   bne +
  1032  8545 b90102                 lda inputbuf+1, y
  1033  8548 c90d                   cmp #13
  1034                              ; no need to increment y if found, done parsing line
  1035  854a 60                 +   rts
  1036                          
  1037                          chkhelpregisters:
  1038  854b b90002                 lda inputbuf, y
  1039  854e c92e                   cmp #'.'
  1040  8550 d005                   bne +
  1041  8552 b90102                 lda inputbuf+1, y
  1042  8555 c90d                   cmp #13
  1043  8557 60                 +   rts
  1044                          
  1045                          chkhelpmodes:
  1046  8558 a96a                   lda #<modes_keyword
  1047  855a a292                   ldx #>modes_keyword
  1048                              ; fall through to chkkeyword
  1049                          
  1050                          chkkeyword:
  1051  855c 84a3                   sty count
  1052  855e 8526                   sta ptr3
  1053  8560 8627                   stx ptr3+1
  1054  8562 a6a3                   ldx count
  1055  8564 a000                   ldy #0
  1056  8566 bd0002             -   lda inputbuf, x
  1057  8569 d126                   cmp (ptr3),y
  1058  856b d008                   bne +
  1059  856d e8                     inx
  1060  856e c8                     iny
  1061  856f e4a4                   cpx len
  1062  8571 d0f3                   bne -
  1063  8573 b126                   lda (ptr3),y ; matched if end of string, will set Z
  1064  8575 08                 +   php ; save Z
  1065  8576 a4a3                   ldy count
  1066  8578 28                     plp ; restore Z
  1067  8579 60                     rts
  1068                          
  1069                          displayinstructions:
  1070  857a a038                   ldy #ninst
  1071  857c a200                   ldx #0
  1072  857e 8a                 -   txa
  1073  857f 48                     pha
  1074  8580 20d881                 jsr dispinst
  1075  8583 a920                   lda #' '
  1076  8585 20d2ff                 jsr charout
  1077  8588 68                     pla
  1078  8589 aa                     tax
  1079  858a e8                     inx
  1080  858b 88                     dey
  1081  858c d0f0                   bne -
  1082  858e 4c2a8b                 jmp newline
  1083                          
  1084                          displaymodes:
  1085  8591 38                     sec
  1086  8592 a900                   lda #0
  1087  8594 48                 -   pha
  1088  8595 aa                     tax
  1089  8596 bdf98c                 lda mode_sorted, x
  1090  8599 20a685                 jsr dispmode
  1091  859c 68                     pla
  1092  859d 18                     clc
  1093  859e 6901                   adc #1
  1094  85a0 c90d                   cmp #nmodes
  1095  85a2 90f0                   bcc -
  1096  85a4 18                     clc
  1097  85a5 60                     rts
  1098                          
  1099                          dispmode:
  1100  85a6 c90d                   cmp #nmodes
  1101  85a8 b008                   bcs +
  1102  85aa 8524                   sta mode
  1103  85ac 20ee85                 jsr disp_modename_and_example
  1104  85af 4cb385                 jmp dispmodeinstructions
  1105  85b2 60                 +   rts
  1106                          
  1107                          dispmodeinstructions:
  1108                          !ifdef C64SCREEN {
  1109                              ; 3 IndirectX and 4 IndirectY are the same, so compact them together to fit on screen
  1110  85b3 a524                   lda mode
  1111  85b5 c903                   cmp #3
  1112  85b7 d005                   bne +
  1113  85b9 a920                   lda #' '
  1114  85bb 4cd2ff                 jmp charout
  1115                          }
  1116                              ; display instructions with this mode
  1117  85be a000               +   ldy #0
  1118  85c0 8423               --  sty inidx
  1119  85c2 a200                   ldx #0
  1120  85c4 86ff               -   stx tmp
  1121  85c6 a523                   lda inidx
  1122  85c8 dd8f8e                 cmp instidx, x
  1123  85cb d014                   bne ++
  1124  85cd bd268f                 lda modeidx, x
  1125  85d0 c524                   cmp mode
  1126  85d2 d00d                   bne ++
  1127  85d4 a920                   lda #' '
  1128  85d6 20d2ff                 jsr charout
  1129  85d9 bd8f8e                 lda instidx, x
  1130  85dc 20d881                 jsr dispinst
  1131  85df a6ff                   ldx tmp
  1132  85e1 e8                 ++  inx
  1133  85e2 e097                   cpx #nopcodes
  1134  85e4 90de                   bcc -
  1135  85e6 c8                     iny
  1136  85e7 c038                   cpy #ninst
  1137  85e9 d0d5                   bne --
  1138  85eb 4c2a8b                 jmp newline
  1139                          
  1140                          disp_modename_and_example:
  1141  85ee 0a                     asl
  1142  85ef aa                     tax
  1143  85f0 bdde8d                 lda modes, x
  1144  85f3 48                     pha
  1145  85f4 bddf8d                 lda modes+1, x
  1146  85f7 aa                     tax
  1147                          !ifdef C64SCREEN {
  1148  85f8 a912                   lda #18
  1149  85fa 20d2ff                 jsr charout
  1150                          }    
  1151  85fd 68                     pla
  1152  85fe 20c383                 jsr strout
  1153  8601 a920                   lda #' '
  1154  8603 20d2ff                 jsr charout
  1155  8606 20c783                 jsr strout2
  1156                          !ifdef C64SCREEN {    
  1157  8609 a992                   lda #146
  1158  860b 20d2ff                 jsr charout
  1159                          }   
  1160  860e 60                     rts
  1161                          
  1162                          disp_modename_instruction_example:
  1163  860f 0a                     asl
  1164  8610 aa                     tax
  1165  8611 bdde8d                 lda modes, x
  1166  8614 48                     pha
  1167  8615 bddf8d                 lda modes+1, x
  1168  8618 aa                     tax
  1169  8619 68                     pla
  1170  861a 20c383                 jsr strout ; mode name
  1171  861d a526                   lda ptr3
  1172  861f 48                     pha
  1173  8620 a527                   lda ptr3+1
  1174  8622 48                     pha
  1175  8623 a93a                   lda #':'
  1176  8625 20d2ff                 jsr charout
  1177  8628 a920                   lda #' '
  1178  862a 20d2ff                 jsr charout
  1179  862d a523                   lda inidx
  1180  862f 20d881                 jsr dispinst ; instruction
  1181  8632 a920                   lda #' '
  1182  8634 20d2ff                 jsr charout
  1183  8637 68                     pla
  1184  8638 8527                   sta ptr3+1
  1185  863a 68                     pla
  1186  863b 8526                   sta ptr3
  1187  863d 20c783                 jsr strout2 ; example
  1188  8640 60                     rts
  1189                          
  1190                          
  1191                          executehelpinstruction:
  1192  8641 a000                   ldy #0
  1193  8643 8422               -   sty opidx
  1194  8645 b98f8e                 lda instidx, y
  1195  8648 c523                   cmp inidx
  1196  864a d01a                   bne +
  1197  864c b9268f                 lda modeidx, y
  1198  864f 8524                   sta mode
  1199  8651 a622                   ldx opidx
  1200  8653 bdf88d                 lda opcodes, x
  1201  8656 204d83                 jsr disphexbyte
  1202  8659 a920                   lda #' '
  1203  865b 20d2ff                 jsr charout
  1204  865e a524                   lda mode
  1205  8660 200f86                 jsr disp_modename_instruction_example
  1206  8663 202a8b                 jsr newline
  1207  8666 a422               +   ldy opidx
  1208  8668 c8                     iny
  1209  8669 c097                   cpy #nopcodes
  1210  866b 90d6                   bcc -
  1211  866d 60                     rts
  1212                          
  1213                          continueassemble:
  1214                          !ifdef C64SCREEN {   
  1215  866e 20cb80                 jsr continueassemblec64
  1216                          }
  1217                              ; continue...
  1218                          
  1219                          executeassemble:
  1220  8671 68                     pla ; remove low byte return address
  1221  8672 68                     pla ; return high byte return address
  1222                          !ifdef C64SCREEN {    
  1223  8673 a914                   lda #20
  1224  8675 20d2ff                 jsr charout
  1225  8678 20d2ff                 jsr charout
  1226                          } else {
  1227                              lda ptr1
  1228                              ldx ptr1+1
  1229                              jsr disphexword
  1230                              lda #' '
  1231                              jsr charout
  1232                          }
  1233                              ; save current pointer
  1234  867b a5fb               --  lda ptr1
  1235  867d a6fc                   ldx ptr1+1
  1236  867f 8526                   sta ptr3
  1237  8681 8627                   stx ptr3+1
  1238  8683 20de83                 jsr inputline
  1239  8686 c001                   cpy #1
  1240  8688 f048                   beq ++
  1241  868a 88                     dey
  1242  868b 84a4                   sty len
  1243  868d a000                   ldy #0
  1244  868f 20838a                 jsr skipspaces
  1245  8692 c4a4                   cpy len
  1246  8694 f03c                   beq ++
  1247                              ;jsr chkhexaddr1 *** WARNING: interferes with ADC, BCC, DEC because those names are exclusively valid HEX alphabetic characters
  1248                              ;jsr skipspaces
  1249  8696 20a889                 jsr chkinstruction
  1250  8699 f00b                   beq +
  1251  869b a526               -   lda ptr3
  1252  869d 85fb                   sta ptr1
  1253  869f a527                   lda ptr3+1
  1254  86a1 85fc                   sta ptr1+1
  1255  86a3 4c2384                 jmp error
  1256  86a6 20fc86             +   jsr chkaddressing
  1257  86a9 d0f0                   bne -
  1258  86ab 20d989                 jsr find_inst_and_mode
  1259  86ae d0eb                   bne -
  1260  86b0 20d586                 jsr store_assembly ; TODO disassemble on screen as assemble for validation
  1261  86b3 18                     clc
  1262  86b4 a525                   lda size
  1263  86b6 6526                   adc ptr3
  1264  86b8 85fb                   sta ptr1
  1265  86ba a527                   lda ptr3+1
  1266  86bc 6900                   adc #0
  1267  86be 85fc                   sta ptr1+1
  1268                          !ifdef C64SCREEN {    
  1269  86c0 202a8b                 jsr newline
  1270                          }
  1271  86c3 a5fb                   lda ptr1
  1272  86c5 a6fc                   ldx ptr1+1
  1273  86c7 204783                 jsr disphexword
  1274  86ca a920                   lda #' '
  1275  86cc 20d2ff                 jsr charout
  1276  86cf 4c7b86                 jmp --
  1277                          ++  
  1278                          !ifdef C64SCREEN {
  1279  86d2 4c2a8b                 jmp newline
  1280                          } else {
  1281                              rts
  1282                          }
  1283                          
  1284                          store_assembly:
  1285  86d5 a622                   ldx opidx
  1286  86d7 bdf88d                 lda opcodes, x
  1287  86da a000                   ldy #0
  1288  86dc 9126                   sta (ptr3), y
  1289  86de c8                     iny
  1290  86df a625                   ldx size
  1291  86e1 e001                   cpx #1
  1292  86e3 f016                   beq ++
  1293  86e5 e002               +   cpx #2
  1294  86e7 d005                   bne +
  1295  86e9 a5a6                   lda tmp2
  1296  86eb 9126                   sta (ptr3), y
  1297  86ed 60                     rts
  1298  86ee e003               +   cpx #3
  1299  86f0 d009                   bne ++
  1300  86f2 a5fb                   lda ptr1
  1301  86f4 9126                   sta (ptr3), y
  1302  86f6 c8                     iny
  1303  86f7 a5fc                   lda ptr1+1
  1304  86f9 9126                   sta (ptr3), y
  1305  86fb 60                 ++  rts
  1306                          
  1307                          chkaddressing: ; match input to addressing mode, note caller may need to adjust
  1308  86fc 20838a                 jsr skipspaces
  1309  86ff a200                   ldx #0
  1310  8701 8624                   stx mode
  1311  8703 205e87                 jsr chkaccumulator
  1312  8706 f051                   beq +
  1313  8708 e624                   inc mode
  1314  870a c4a4                   cpy len ; chknone
  1315  870c f04b                   beq +
  1316  870e e624                   inc mode
  1317  8710 208287                 jsr chkimmediate
  1318  8713 f044                   beq +
  1319  8715 e624                   inc mode
  1320  8717 20a687                 jsr chkindirectx
  1321  871a f03d                   beq +
  1322  871c e624                   inc mode
  1323  871e 20eb87                 jsr chkindirecty
  1324  8721 f036                   beq +
  1325  8723 e624                   inc mode
  1326  8725 203088                 jsr chkrelative
  1327  8728 f02f                   beq +
  1328  872a e624                   inc mode
  1329  872c 208b88                 jsr chkzeropage
  1330  872f f028                   beq +
  1331  8731 e624                   inc mode
  1332  8733 20a488                 jsr chkzeropagex
  1333  8736 f021                   beq +
  1334  8738 e624                   inc mode
  1335  873a 20d388                 jsr chkzeropagey
  1336  873d f01a                   beq +
  1337  873f e624                   inc mode
  1338  8741 200289                 jsr chkabsolute
  1339  8744 f013                   beq +
  1340  8746 e624                   inc mode
  1341  8748 201b89                 jsr chkabsolutex
  1342  874b f00c                   beq +
  1343  874d e624                   inc mode
  1344  874f 204a89                 jsr chkabsolutey
  1345  8752 f005                   beq +
  1346  8754 e624                   inc mode
  1347  8756 207989                 jsr chkindirect
  1348  8759 08                 +   php ; save Z
  1349  875a a524                   lda mode
  1350  875c 28                     plp ; restore Z 
  1351  875d 60                     rts
  1352                          
  1353                          chkaccumulator:
  1354  875e c4a4                   cpy len
  1355  8760 d013                   bne +
  1356  8762 a523                   lda inidx
  1357  8764 c902                   cmp #2 ; ASL
  1358  8766 f019                   beq ++
  1359  8768 c920                   cmp #32 ; LSR
  1360  876a f015                   beq ++
  1361  876c c927                   cmp #39 ; ROL
  1362  876e f011                   beq ++
  1363  8770 c928                   cmp #40 ; ROR
  1364  8772 4c8187                 jmp ++
  1365  8775 b90002             +   lda inputbuf, y
  1366  8778 c941                   cmp #'A'
  1367  877a d005                   bne ++
  1368  877c b90102                 lda inputbuf+1,y
  1369  877f c90d                   cmp #13 ; Z set true/false whether parsed exactly
  1370  8781 60                 ++  rts
  1371                          
  1372                          chkimmediate:
  1373  8782 84a5                   sty savepos
  1374  8784 b90002                 lda inputbuf, y
  1375  8787 c923                   cmp #'#'
  1376  8789 d016                   bne ++
  1377  878b c8                     iny
  1378  878c 20838a                 jsr skipspaces
  1379  878f b90002                 lda inputbuf, y
  1380  8792 c924                   cmp #'$'
  1381  8794 d001                   bne +
  1382  8796 c8                     iny
  1383  8797 20d68a             +   jsr chkhexbyte
  1384  879a d005                   bne ++
  1385  879c c4a4               +   cpy len
  1386  879e d001                   bne ++
  1387  87a0 60                     rts
  1388  87a1 a4a5               ++  ldy savepos
  1389  87a3 a201                   ldx #1 ; Z false (NE)
  1390  87a5 60                     rts
  1391                          
  1392                          chkindirectx:
  1393  87a6 84a5                   sty savepos
  1394  87a8 b90002                 lda inputbuf, y
  1395  87ab c928                   cmp #'('
  1396  87ad d037                   bne ++
  1397  87af c8                     iny
  1398  87b0 20838a                 jsr skipspaces
  1399  87b3 b90002                 lda inputbuf, y
  1400  87b6 c924                   cmp #'$'
  1401  87b8 d001                   bne +
  1402  87ba c8                     iny
  1403  87bb 20d68a             +   jsr chkhexbyte
  1404  87be d026                   bne ++
  1405  87c0 20838a                 jsr skipspaces
  1406  87c3 b90002                 lda inputbuf, y
  1407  87c6 c92c                   cmp #','
  1408  87c8 d01c                   bne ++
  1409  87ca c8                     iny
  1410  87cb 20838a                 jsr skipspaces
  1411  87ce b90002                 lda inputbuf, y
  1412  87d1 c958                   cmp #'X'
  1413  87d3 d011                   bne ++
  1414  87d5 c8                     iny
  1415  87d6 20838a                 jsr skipspaces
  1416  87d9 b90002                 lda inputbuf, y
  1417  87dc c929                   cmp #')'
  1418  87de d006                   bne ++
  1419  87e0 c8                     iny
  1420  87e1 c4a4                   cpy len
  1421  87e3 d001                   bne ++
  1422  87e5 60                     rts
  1423  87e6 a4a5               ++  ldy savepos
  1424  87e8 a201                   ldx #1 ; Z false (NE)
  1425  87ea 60                     rts
  1426                          
  1427                          chkindirecty:
  1428  87eb 84a5                   sty savepos
  1429  87ed b90002                 lda inputbuf, y
  1430  87f0 c928                   cmp #'('
  1431  87f2 d037                   bne ++
  1432  87f4 c8                     iny
  1433  87f5 20838a                 jsr skipspaces
  1434  87f8 b90002                 lda inputbuf, y
  1435  87fb c924                   cmp #'$'
  1436  87fd d001                   bne +
  1437  87ff c8                     iny
  1438  8800 20d68a             +   jsr chkhexbyte
  1439  8803 d026                   bne ++
  1440  8805 20838a                 jsr skipspaces
  1441  8808 b90002                 lda inputbuf, y
  1442  880b c929                   cmp #')'
  1443  880d d01c                   bne ++
  1444  880f c8                     iny
  1445  8810 20838a                 jsr skipspaces
  1446  8813 b90002                 lda inputbuf, y
  1447  8816 c92c                   cmp #','
  1448  8818 d011                   bne ++
  1449  881a c8                     iny
  1450  881b 20838a                 jsr skipspaces
  1451  881e b90002                 lda inputbuf, y
  1452  8821 c959                   cmp #'Y'
  1453  8823 d006                   bne ++
  1454  8825 c8                     iny
  1455  8826 c4a4                   cpy len
  1456  8828 d001                   bne ++
  1457  882a 60                     rts
  1458  882b a4a5               ++  ldy savepos
  1459  882d a201                   ldx #1 ; Z false (NE)
  1460  882f 60                     rts
  1461                          
  1462                          chkrelative:
  1463  8830 84a5                   sty savepos
  1464  8832 a623                   ldx inidx
  1465  8834 e006                   cpx #6 ; BIT
  1466  8836 f01e                   beq ++
  1467  8838 bd378c                 lda inst0, x
  1468  883b c942                   cmp #'B'
  1469  883d d017                   bne ++
  1470  883f b90002                 lda inputbuf, y
  1471  8842 c924                   cmp #'$'
  1472  8844 d001                   bne +
  1473  8846 c8                     iny
  1474  8847 20cd8a             +   jsr chkhexword
  1475  884a d00a                   bne ++
  1476  884c c4a4                   cpy len
  1477  884e d006                   bne ++
  1478  8850 205b88                 jsr computeoffset
  1479  8853 d001                   bne ++
  1480  8855 60                     rts ; Z true (EQ)
  1481  8856 a4a5               ++  ldy savepos
  1482  8858 a201                   ldx #1 ; Z false (NE)
  1483  885a 60                     rts
  1484                          
  1485                          computeoffset:
  1486                          ;   compute next address
  1487  885b a527                   lda ptr3+1
  1488  885d 85fe                   sta ptr2+1
  1489  885f a526                   lda ptr3
  1490  8861 18                     clc
  1491  8862 6902                   adc #2
  1492  8864 85fd                   sta ptr2
  1493  8866 9002                   bcc +
  1494  8868 e6fe                   inc ptr2+1
  1495                          +  ; subtract argument
  1496  886a 38                     sec
  1497  886b a5fb                   lda ptr1
  1498  886d e5fd                   sbc ptr2
  1499  886f 85a6                   sta tmp2
  1500  8871 a5fc                   lda ptr1+1
  1501  8873 e5fe                   sbc ptr2+1
  1502  8875 f00a                   beq chkoffsetto127 ; offset is byte sized, make sure is positive signed byte
  1503  8877 c9ff                   cmp #$FF
  1504  8879 d00d                   bne failedoffset ; 0 and FF were only options so fail
  1505                              ; chkeck negative offset
  1506  887b a5a6                   lda tmp2
  1507  887d 3006                   bmi successoffset ; branch if signed byte is negative
  1508  887f 1007                   bpl failedoffset ; otherwise fail
  1509                          chkoffsetto127:
  1510  8881 a5a6                   lda tmp2
  1511  8883 3003                   bmi failedoffset ; branch if too large an offset 128 bytes or more
  1512                          successoffset:    
  1513  8885 a900                   lda #0 ; Z true (EQ)
  1514  8887 60                     rts
  1515                          failedoffset:
  1516  8888 a901                   lda #1 ; Z false (NE)
  1517  888a 60                     rts
  1518                          
  1519                          chkzeropage:
  1520  888b 84a5                   sty savepos
  1521  888d b90002                 lda inputbuf, y
  1522  8890 c924                   cmp #'$'
  1523  8892 d001                   bne +
  1524  8894 c8                     iny
  1525  8895 20d68a             +   jsr chkhexbyte
  1526  8898 d005                   bne ++
  1527  889a c4a4                   cpy len
  1528  889c d001                   bne ++
  1529  889e 60                     rts ; Z true (EQ)
  1530  889f a4a5               ++  ldy savepos
  1531  88a1 a201                   ldx #1 ; Z false (NE)
  1532  88a3 60                     rts
  1533                          
  1534                          chkzeropagex:
  1535  88a4 84a5                   sty savepos
  1536  88a6 b90002                 lda inputbuf, y
  1537  88a9 c924                   cmp #'$'
  1538  88ab d001                   bne +
  1539  88ad c8                     iny
  1540  88ae 20d68a             +   jsr chkhexbyte
  1541  88b1 d01b                   bne ++
  1542  88b3 20838a                 jsr skipspaces
  1543  88b6 b90002                 lda inputbuf, y
  1544  88b9 c92c                   cmp #','
  1545  88bb d011                   bne ++
  1546  88bd c8                     iny
  1547  88be 20838a                 jsr skipspaces
  1548  88c1 b90002                 lda inputbuf, y
  1549  88c4 c958                   cmp #'X'
  1550  88c6 d006                   bne ++
  1551  88c8 c8                     iny
  1552  88c9 c4a4                   cpy len
  1553  88cb d001                   bne ++
  1554  88cd 60                     rts ; Z true (EQ)
  1555  88ce a4a5               ++  ldy savepos
  1556  88d0 a201                   ldx #1 ; Z false (NE)
  1557  88d2 60                     rts
  1558                          
  1559                          chkzeropagey:
  1560  88d3 84a5                   sty savepos
  1561  88d5 b90002                 lda inputbuf, y
  1562  88d8 c924                   cmp #'$'
  1563  88da d001                   bne +
  1564  88dc c8                     iny
  1565  88dd 20d68a             +   jsr chkhexbyte
  1566  88e0 d01b                   bne ++
  1567  88e2 20838a                 jsr skipspaces
  1568  88e5 b90002                 lda inputbuf, y
  1569  88e8 c92c                   cmp #','
  1570  88ea d011                   bne ++
  1571  88ec c8                     iny
  1572  88ed 20838a                 jsr skipspaces
  1573  88f0 b90002                 lda inputbuf, y
  1574  88f3 c959                   cmp #'Y'
  1575  88f5 d006                   bne ++
  1576  88f7 c8                     iny
  1577  88f8 c4a4                   cpy len
  1578  88fa d001                   bne ++
  1579  88fc 60                     rts ; Z true (EQ)
  1580  88fd a4a5               ++  ldy savepos
  1581  88ff a201                   ldx #1 ; Z false (NE)
  1582  8901 60                     rts
  1583                          
  1584                          chkabsolute:
  1585  8902 84a5                   sty savepos
  1586  8904 b90002                 lda inputbuf, y
  1587  8907 c924                   cmp #'$'
  1588  8909 d001                   bne +
  1589  890b c8                     iny
  1590  890c 20cd8a             +   jsr chkhexword
  1591  890f d005                   bne ++
  1592  8911 c4a4                   cpy len
  1593  8913 d001                   bne ++
  1594  8915 60                     rts ; Z true (EQ)
  1595  8916 a4a5               ++  ldy savepos
  1596  8918 a201                   ldx #1 ; Z false (NE)
  1597  891a 60                     rts
  1598                          
  1599                          chkabsolutex:
  1600  891b 84a5                   sty savepos
  1601  891d b90002                 lda inputbuf, y
  1602  8920 c924                   cmp #'$'
  1603  8922 d001                   bne +
  1604  8924 c8                     iny
  1605  8925 20cd8a             +   jsr chkhexword
  1606  8928 d01b                   bne ++
  1607  892a 20838a                 jsr skipspaces
  1608  892d b90002                 lda inputbuf, y
  1609  8930 c92c                   cmp #','
  1610  8932 d011                   bne ++
  1611  8934 c8                     iny
  1612  8935 20838a                 jsr skipspaces
  1613  8938 b90002                 lda inputbuf, y
  1614  893b c958                   cmp #'X'
  1615  893d d006                   bne ++
  1616  893f c8                     iny
  1617  8940 c4a4                   cpy len
  1618  8942 d001                   bne ++
  1619  8944 60                     rts ; Z true (EQ)
  1620  8945 a4a5               ++  ldy savepos
  1621  8947 a201                   ldx #1 ; Z false (NE)
  1622  8949 60                     rts
  1623                          
  1624                          chkabsolutey:
  1625  894a 84a5                   sty savepos
  1626  894c b90002                 lda inputbuf, y
  1627  894f c924                   cmp #'$'
  1628  8951 d001                   bne +
  1629  8953 c8                     iny
  1630  8954 20cd8a             +   jsr chkhexword
  1631  8957 d01b                   bne ++
  1632  8959 20838a                 jsr skipspaces
  1633  895c b90002                 lda inputbuf, y
  1634  895f c92c                   cmp #','
  1635  8961 d011                   bne ++
  1636  8963 c8                     iny
  1637  8964 20838a                 jsr skipspaces
  1638  8967 b90002                 lda inputbuf, y
  1639  896a c959                   cmp #'Y'
  1640  896c d006                   bne ++
  1641  896e c8                     iny
  1642  896f c4a4                   cpy len
  1643  8971 d001                   bne ++
  1644  8973 60                     rts ; Z true (EQ)
  1645  8974 a4a5               ++  ldy savepos
  1646  8976 a201                   ldx #1 ; Z false (NE)
  1647  8978 60                     rts
  1648                          
  1649                          chkindirect:
  1650  8979 84a5                   sty savepos
  1651  897b b90002                 lda inputbuf, y
  1652  897e c928                   cmp #'('
  1653  8980 d021                   bne ++
  1654  8982 c8                     iny
  1655  8983 20838a                 jsr skipspaces
  1656  8986 b90002                 lda inputbuf, y
  1657  8989 c924                   cmp #'$'
  1658  898b d001                   bne +
  1659  898d c8                     iny
  1660  898e 20cd8a             +   jsr chkhexword
  1661  8991 d010                   bne ++
  1662  8993 20838a                 jsr skipspaces
  1663  8996 b90002                 lda inputbuf, y
  1664  8999 c929                   cmp #')'
  1665  899b d006                   bne ++
  1666  899d c8                     iny
  1667  899e c4a4                   cpy len
  1668  89a0 d001                   bne ++
  1669  89a2 60                     rts ; Z true (EQ)
  1670  89a3 a4a5               ++  ldy savepos
  1671  89a5 a201                   ldx #1 ; Z false (NE)
  1672  89a7 60                     rts
  1673                          
  1674                          chkinstruction:
  1675  89a8 c4a4                   cpy len
  1676  89aa f02a                   beq ++
  1677  89ac 84ff                   sty tmp
  1678  89ae a237                   ldx #(ninst-1)
  1679  89b0 b90002             -   lda inputbuf,y
  1680  89b3 dd378c                 cmp inst0,x
  1681  89b6 d019                   bne +
  1682  89b8 c8                     iny
  1683  89b9 b90002                 lda inputbuf,y
  1684  89bc dd6f8c                 cmp inst1,x
  1685  89bf d010                   bne +
  1686  89c1 c8                     iny
  1687  89c2 b90002                 lda inputbuf,y
  1688  89c5 dda78c                 cmp inst2,x
  1689  89c8 d007                   bne +
  1690  89ca c8                     iny
  1691  89cb 8a                     txa
  1692  89cc 8523                   sta inidx
  1693  89ce a200                   ldx #0
  1694  89d0 60                     rts
  1695  89d1 a4ff               +   ldy tmp
  1696  89d3 ca                     dex
  1697  89d4 10da                   bpl -
  1698  89d6 a201               ++  ldx #1 ; Z false (NE)
  1699  89d8 60                     rts
  1700                          
  1701                          find_inst_and_mode: ; INPUT: inidx & mode, OUTPUT: Z true: opidx & size, otherwise false
  1702                              ; and allows mode promotion
  1703  89d9 20fd89                 jsr find_inst_and_mode2
  1704  89dc f01e                   beq ++
  1705  89de a524                   lda mode
  1706  89e0 c906                   cmp #6
  1707  89e2 9018                   bcc ++
  1708  89e4 c90a                   cmp #10
  1709  89e6 b012                   bcs +
  1710  89e8 6903                   adc #3
  1711  89ea 8524                   sta mode ; promote ZeroPage modes to Absolute modes
  1712  89ec 20fd89                 jsr find_inst_and_mode2 ; try again once
  1713  89ef d00b                   bne ++
  1714  89f1 a5a6                   lda tmp2
  1715  89f3 85fb                   sta ptr1
  1716  89f5 a900                   lda #0
  1717  89f7 85fc                   sta ptr1+1
  1718  89f9 60                     rts ; Z true (EQ)
  1719  89fa a201               +   ldx #1 ; Z false (NE)
  1720  89fc 60                 ++  rts
  1721                          
  1722                          find_inst_and_mode2: ; INPUT: inidx & mode, OUTPUT: Z true: opidx & size, otherwise false
  1723  89fd a296                   ldx #nopcodes-1
  1724  89ff bd8f8e             -   lda instidx, x
  1725  8a02 bc268f                 ldy modeidx, x
  1726  8a05 c523                   cmp inidx
  1727  8a07 d00c                   bne +
  1728  8a09 c424                   cpy mode
  1729  8a0b d008                   bne +
  1730  8a0d 8622                   stx opidx
  1731  8a0f 20c181                 jsr getsize
  1732  8a12 a200                   ldx #0 ; Z true (EQ)
  1733  8a14 60                     rts
  1734  8a15 ca                 +   dex
  1735  8a16 e0ff                   cpx #$ff
  1736  8a18 d0e5                   bne -
  1737  8a1a a201                   ldx #1 ; Z false (NE)
  1738  8a1c 60                     rts
  1739                          
  1740                          executerun:
  1741  8a1d 68                     pla ; remove low byte return address
  1742  8a1e 68                     pla ; return high byte return address
  1743  8a1f 68                     pla ; again, we're really not returning
  1744  8a20 68                     pla ; again, we're really not returning
  1745  8a21 202a8b                 jsr newline
  1746  8a24 38                     sec
  1747  8a25 a5fb                   lda ptr1
  1748  8a27 e901                   sbc #1
  1749  8a29 85fb                   sta ptr1
  1750  8a2b b005                   bcs +
  1751  8a2d c6fc                   dec ptr1+1
  1752                          !ifndef MINIMUM {
  1753                          ; any C64
  1754  8a2f 203980                 jsr install_nmi64
  1755                          }
  1756  8a32 a5fc               +   lda ptr1+1
  1757  8a34 48                     pha
  1758  8a35 a5fb                   lda ptr1
  1759  8a37 48                     pha
  1760  8a38 60                     rts
  1761                          
  1762                          chkcontinuedis:
  1763  8a39 b90002                 lda inputbuf,y
  1764  8a3c c944                   cmp #'D'
  1765  8a3e d00a                   bne +
  1766  8a40 b90102                 lda inputbuf+1,y
  1767  8a43 c90d                   cmp #13
  1768  8a45 d003                   bne +
  1769  8a47 c8                     iny
  1770  8a48 a200                   ldx #0 ; restore Z set
  1771  8a4a 60                 +   rts
  1772                          
  1773                          chkcontinueasm:
  1774  8a4b b90002                 lda inputbuf,y
  1775  8a4e c941                   cmp #'A'
  1776  8a50 d00a                   bne +
  1777  8a52 b90102                 lda inputbuf+1,y
  1778  8a55 c90d                   cmp #13
  1779  8a57 d003                   bne +
  1780  8a59 c8                     iny
  1781  8a5a a200                   ldx #0 ; restore Z set
  1782  8a5c 60                 +   rts
  1783                          
  1784                          executedisassemble:
  1785  8a5d 68                     pla ; remove low byte return address
  1786  8a5e 68                     pla ; return high byte return address
  1787  8a5f 202a8b                 jsr newline
  1788  8a62 4c6981                 jmp disassemble
  1789                          
  1790                          reportnotimplemented:
  1791  8a65 a97a                   lda #<notimplemented
  1792  8a67 a290                   ldx #>notimplemented
  1793  8a69 4cc383                 jmp strout
  1794                          
  1795                          reporterr:
  1796  8a6c c000                   cpy #0
  1797  8a6e f008                   beq +
  1798  8a70 a920                   lda #' '
  1799  8a72 20d2ff             -   jsr charout
  1800  8a75 88                     dey
  1801  8a76 d0fa                   bne -
  1802  8a78 a93f               +   lda #'?'
  1803  8a7a 20d2ff                 jsr charout
  1804  8a7d a90d                   lda #13
  1805  8a7f 20d2ff                 jsr charout
  1806  8a82 60                     rts
  1807                          
  1808                          skipspaces:
  1809  8a83 b90002             -   lda inputbuf, y
  1810                          !ifndef MINIMUM {
  1811                              ; skip SHIFT-SPACES too on Commodore
  1812  8a86 c9a0                   cmp #$A0
  1813  8a88 f004                   beq +
  1814                          }
  1815  8a8a c920                   cmp #$20
  1816  8a8c d003                   bne ++
  1817  8a8e c8                 +   iny
  1818  8a8f d0f2                   bne -
  1819  8a91 60                 ++  rts
  1820                          
  1821                          chkdot:
  1822  8a92 b90002                 lda inputbuf, y
  1823  8a95 c92e                   cmp #'.'
  1824  8a97 d003                   bne +
  1825  8a99 c8                     iny
  1826  8a9a a900                   lda #0 ; Z true (EQ)
  1827  8a9c 60                 +   rts
  1828                          
  1829                          chkhelp:
  1830  8a9d b90002                 lda inputbuf, y
  1831  8aa0 c93f                   cmp #'?'
  1832  8aa2 d003                   bne +
  1833  8aa4 c8                     iny
  1834  8aa5 a900                   lda #0 ; Z true (EQ)
  1835  8aa7 60                 +   rts
  1836                          
  1837                          chkcolon:
  1838  8aa8 b90002                 lda inputbuf, y
  1839  8aab c93a                   cmp #':'
  1840  8aad d003                   bne +
  1841  8aaf c8                     iny
  1842  8ab0 a900                   lda #0 ; Z true (EQ)
  1843  8ab2 60                 +   rts
  1844                          
  1845                          chkhexbyteofsequence:
  1846  8ab3 208983                 jsr inputhexbyte
  1847  8ab6 20d08a                 jsr +
  1848  8ab9 d011                   bne ++ ; Z false (NE) if failed checks
  1849  8abb c4a4                   cpy len
  1850  8abd f00d                   beq ++ ; Z true (EQ) if end of input
  1851  8abf 85ff                   sta tmp
  1852  8ac1 b90002                 lda inputbuf,y
  1853  8ac4 c920                   cmp #$20
  1854  8ac6 d004                   bne ++ ; Z false (NE) if not space
  1855  8ac8 a5ff                   lda tmp
  1856  8aca a200                   ldx #0 ; Z true (EQ) is space delimeter
  1857  8acc 60                 ++  rts
  1858                          
  1859                          chkhexword:
  1860                          chkhexaddr1:
  1861  8acd 206383                 jsr inputhexword
  1862  8ad0 a200               +   ldx #0 ; Z true (EQ)
  1863  8ad2 9001                   bcc +
  1864  8ad4 e8                     inx ; Z false (NE)
  1865  8ad5 60                 +   rts
  1866                          
  1867                          chkhexbyte:
  1868  8ad6 98                     tya
  1869  8ad7 48                     pha ; save y
  1870  8ad8 208983                 jsr inputhexbyte
  1871  8adb b00d                   bcs +
  1872  8add 85a6                   sta tmp2
  1873  8adf 20a583                 jsr inputhexnybble
  1874  8ae2 9006                   bcc +
  1875  8ae4 68                     pla ; throw away saved y
  1876  8ae5 a5a6                   lda tmp2
  1877  8ae7 a200                   ldx #0 ; Z true (EQ)
  1878  8ae9 60                     rts
  1879  8aea 68                 +   pla
  1880  8aeb a8                     tay ; won't be zero, so Z false (NE)
  1881  8aec 60                     rts    
  1882                          
  1883                          chkhexaddr2:
  1884  8aed a5fb                   lda ptr1
  1885  8aef 48                     pha
  1886  8af0 a5fc                   lda ptr1+1
  1887  8af2 48                     pha
  1888  8af3 20cd8a                 jsr chkhexaddr1
  1889  8af6 f005                   beq +
  1890  8af8 68                     pla
  1891  8af9 68                     pla
  1892  8afa a901                   lda #1 ; Z false (NE)
  1893  8afc 60                     rts
  1894  8afd a5fb               +   lda ptr1
  1895  8aff 85fd                   sta ptr2
  1896  8b01 a5fc                   lda ptr1+1
  1897  8b03 85fe                   sta ptr2+1
  1898  8b05 68                     pla
  1899  8b06 85fc                   sta ptr1+1
  1900  8b08 68                     pla
  1901  8b09 85fb                   sta ptr1
  1902  8b0b a900                   lda #0 ; Z true (EQ)
  1903  8b0d 60                     rts    
  1904                          
  1905                          chkaddr1cmd:
  1906  8b0e b90002                 lda inputbuf, y
  1907  8b11 c941               +   cmp #'A'
  1908  8b13 d004                   bne +
  1909  8b15 c8                     iny
  1910  8b16 4c7186                 jmp executeassemble
  1911  8b19 c944               +   cmp #'D'
  1912  8b1b d004                   bne +
  1913  8b1d c8                     iny
  1914  8b1e 4c5d8a                 jmp executedisassemble
  1915  8b21 c952               +   cmp #'R'
  1916  8b23 d004                   bne +
  1917  8b25 c8                     iny
  1918  8b26 4c1d8a                 jmp executerun
  1919  8b29 60                 +   rts
  1920                          
  1921                          newline:
  1922  8b2a a90d                   lda #13
  1923  8b2c 4cd2ff                 jmp charout
  1924                          
  1925                          space:
  1926  8b2f a920                   lda #32
  1927  8b31 4cd2ff                 jmp charout
  1928                          
  1929                          ; charout: ; for debugging, wait for scan line to pass over entire screen at least once
  1930                          ;     jsr $ffd2
  1931                          ;     pha
  1932                          ; -   lda $d011
  1933                          ;     bpl -
  1934                          ; -   lda $d011
  1935                          ;     bmi -
  1936                          ; -   lda $d011
  1937                          ;     bpl -
  1938                          ; -   lda $d011
  1939                          ;     bmi -
  1940                          ;     pla
  1941                          ;     rts
  1942                          
  1943                          save_regs_and_stack:
  1944                          
  1945                          ; save registers
  1946  8b34 8d9192             sta registerA
  1947  8b37 8e9292             stx registerX
  1948  8b3a 8c9392             sty registerY
  1949                          
  1950                          ; detect N/Z flags without affecting stack
  1951  8b3d 3010               bmi +
  1952  8b3f f007               beq p_pl_eq
  1953                          
  1954  8b41 a900               lda #$00 ;p_pl_ne
  1955  8b43 8d9592             sta registerSR
  1956  8b46 f015               beq ++
  1957                          
  1958                          p_pl_eq:
  1959  8b48 a902               lda #$02
  1960  8b4a 8d9592             sta registerSR
  1961  8b4d 100e               bpl ++ 
  1962                          
  1963  8b4f f007               + beq p_mi_eq
  1964  8b51 a980               lda #$80 ;p_mi_ne
  1965  8b53 8d9592             sta registerSR
  1966  8b56 3005               bmi ++
  1967                          
  1968                          p_mi_eq:
  1969  8b58 a982               lda #$82
  1970  8b5a 8d9592             sta registerSR
  1971                          
  1972                          ; save SP register, affects N/Z
  1973  8b5d ba                 ++tsx
  1974  8b5e 8e9492             stx registerSP
  1975                          
  1976                          ; save stack, affects N/Z
  1977  8b61 a200               ldx #0
  1978  8b63 bd0001             -lda $100,x
  1979  8b66 9d9892             sta savestack,x
  1980  8b69 e8                 inx
  1981  8b6a d0f7               bne -
  1982                          
  1983                          ; save flags, combining unaffected ones with saved N/Z
  1984  8b6c 08                 php
  1985  8b6d 68                 pla
  1986  8b6e 297d               and #$7d
  1987  8b70 0d9592             ora registerSR
  1988  8b73 8d9592             sta registerSR
  1989                          
  1990                          ; restore stack byte affected
  1991  8b76 aa                 tax
  1992  8b77 bd9892             lda savestack,x
  1993  8b7a 9d0001             sta $100,x
  1994                          
  1995  8b7d 4c828b             jmp +
  1996                          
  1997                          execute_display_registers:
  1998  8b80 68                 pla ; remove return address
  1999  8b81 68                 pla
  2000                          +
  2001                          
  2002                          ; need some normality
  2003  8b82 58                 cli
  2004  8b83 d8                 cld
  2005                          
  2006  8b84 202a8b             jsr newline
  2007  8b87 20908b             jsr display_registers
  2008                          !ifndef MINIMUM {
  2009                          ; any C64
  2010  8b8a 205480             jsr uninstall_nmi64
  2011                          }
  2012  8b8d 4c3080             jmp input_loop
  2013                          
  2014                          ; PC   NV-BDIZC .A .X .Y .S
  2015                          ; 1234 10111011 01 02 03 FF
  2016                          display_registers:
  2017  8b90 a96f                   lda #<reg_header
  2018  8b92 a292                   ldx #>reg_header
  2019  8b94 20c383                 jsr strout
  2020  8b97 ad9692                 lda registerPC
  2021  8b9a ae9792                 ldx registerPC+1
  2022  8b9d 204783                 jsr disphexword
  2023  8ba0 202f8b                 jsr space
  2024  8ba3 ad9592                 lda registerSR
  2025  8ba6 203483                 jsr dispbinbyte
  2026  8ba9 202f8b                 jsr space
  2027  8bac ad9192                 lda registerA
  2028  8baf 204d83                 jsr disphexbyte
  2029  8bb2 202f8b                 jsr space
  2030  8bb5 ad9292                 lda registerX
  2031  8bb8 204d83                 jsr disphexbyte
  2032  8bbb 202f8b                 jsr space
  2033  8bbe ad9392                 lda registerY
  2034  8bc1 204d83                 jsr disphexbyte
  2035  8bc4 202f8b                 jsr space
  2036  8bc7 ad9492                 lda registerSP
  2037  8bca 204d83                 jsr disphexbyte
  2038  8bcd 4c2a8b                 jmp newline
  2039                          
  2040                          loadregs_go:
  2041  8bd0 a000                   ldy #0
  2042  8bd2 b99892             -   lda savestack,y
  2043  8bd5 990001                 sta $100,y
  2044  8bd8 c8                     iny
  2045  8bd9 d0f7                   bne -
  2046  8bdb ae9492                 ldx registerSP
  2047  8bde 9a                     txs
  2048  8bdf ad9592                 lda registerSR
  2049  8be2 48                     pha
  2050  8be3 ad9192                 lda registerA
  2051  8be6 ae9292                 ldx registerX
  2052  8be9 ac9392                 ldy registerY
  2053  8bec 28                     plp
  2054  8bed 6c9692                 jmp (registerPC)
  2055                          
  2056                          !ifdef MINIMUM {
  2057                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  2058                          ;; MC6850
  2059                          UART_DATA=$FFF8
  2060                          UART_STCR=$FFF9
  2061                          
  2062                          UART_INIT:
  2063                          	ldx #0b00000111 ; 11=reset device
  2064                          	stx UART_STCR
  2065                          	inx ; #0b00001000 ; 0=rint disabled, 00=rtsn low, tint disabled 010=7e1 00=div 1
  2066                          	sta UART_STCR
  2067                          	rts
  2068                          UART_OUT:
  2069                          	pha
  2070                          -	lda UART_STCR
  2071                          	and #2
  2072                          	beq - ; branch if TDRE=0, not finished transmitting
  2073                          	pla
  2074                          	pha
  2075                          	and #$7F ; force 7-bit ASCII output, mask out any high bit
  2076                          	sta UART_DATA
  2077                          	pla
  2078                          	rts
  2079                          UART_IN:
  2080                          -	lda UART_STCR
  2081                          	and #1
  2082                          	beq - ; branch if TDRF=0, not received
  2083                          	lda UART_DATA
  2084                          	; software "CAPS LOCK" because wozmon expects only uppercase
  2085                          	cmp #$1C ; ^\ to act like a BRK, to return to monitor, if reading keys
  2086                          	beq BREAK
  2087                              ; force lowercase alphabet to uppercase
  2088                              cmp #'a'
  2089                          	bcc +
  2090                          	cmp #'z'+1
  2091                          	bcs +
  2092                          	eor #$20
  2093                          +	;ora #$80 ; Apple Model 1 expects 7-bit with marked parity (8th bit always set)
  2094                           	rts
  2095                          UART_CHK: ; set or clear N flag based on read ready (character waiting)
  2096                          	pha ; save A
  2097                          	lda UART_STCR
  2098                          	lsr ; put rightmost bit in carry
  2099                          	pla ; restore A affects flags
  2100                          	ror ; move carry to left bit, right bit to carry
  2101                          	php ; push processor to save N
  2102                          	rol ; restore A affects flags
  2103                          	plp ; pull processor to restore N
  2104                          	rts
  2105                          
  2106                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  2107                          ; Processor start and interrupts
  2108                          
  2109                          NMI: ; unused on minimum (no source of interrupt)
  2110                              rti
  2111                          
  2112                          IRQ:
  2113                              pha
  2114                              php
  2115                              pla
  2116                              and #$10
  2117                              beq ++ ; not break
  2118                          ;BREAK HANDLER
  2119                              pla
  2120                              sta registerA
  2121                              pla
  2122                              sta registerSR
  2123                              pla
  2124                              cld
  2125                              sec
  2126                              sbc #2
  2127                              sta registerPC
  2128                              pla
  2129                              sbc #0
  2130                              sta registerPC+1
  2131                              lda #>save_regs_and_stack
  2132                              pha
  2133                              lda #<save_regs_and_stack
  2134                              pha
  2135                              lda registerSR
  2136                              pha
  2137                              lda registerA
  2138                              pha
  2139                          ++  pla
  2140                              rti
  2141                          
  2142                          BREAK:
  2143                              jmp RESET
  2144                          
  2145                          RESET:
  2146                              cld
  2147                              ldx #$FF
  2148                              txs
  2149                              jsr JUART_INIT
  2150                              cli
  2151                              jmp start
  2152                          ; !ifdef MINIMUM
  2153                          } else { ; not MINIMUM
  2154                          nmi64:
  2155  8bf0 78                     sei
  2156  8bf1 8d9192                 sta registerA
  2157  8bf4 68                     pla
  2158  8bf5 8d9592                 sta registerSR
  2159  8bf8 68                     pla
  2160  8bf9 d8                     cld
  2161  8bfa 8d9692                 sta registerPC
  2162  8bfd 68                     pla
  2163  8bfe 8d9792                 sta registerPC+1
  2164  8c01 a98b                   lda #>save_regs_and_stack
  2165  8c03 48                     pha
  2166  8c04 a934                   lda #<save_regs_and_stack
  2167  8c06 48                     pha
  2168  8c07 ad9592                 lda registerSR
  2169  8c0a 48                     pha
  2170  8c0b ad9192                 lda registerA
  2171  8c0e 40                     rti
  2172                          
  2173                          brk64:
  2174  8c0f 68                     pla
  2175  8c10 a8                     tay
  2176  8c11 68                     pla
  2177  8c12 aa                     tax
  2178  8c13 68                     pla
  2179  8c14 8d9192                 sta registerA
  2180  8c17 68                     pla
  2181  8c18 8d9592                 sta registerSR
  2182  8c1b 68                     pla
  2183  8c1c d8                     cld
  2184  8c1d 38                     sec
  2185  8c1e e902                   sbc #2
  2186  8c20 8d9692                 sta registerPC
  2187  8c23 68                     pla
  2188  8c24 e900                   sbc #0
  2189  8c26 8d9792                 sta registerPC+1
  2190  8c29 a98b                   lda #>save_regs_and_stack
  2191  8c2b 48                     pha
  2192  8c2c a934                   lda #<save_regs_and_stack
  2193  8c2e 48                     pha
  2194  8c2f ad9592                 lda registerSR
  2195  8c32 48                     pha
  2196  8c33 ad9192                 lda registerA
  2197  8c36 40                     rti
  2198                          }
  2199                          
  2200                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  2201                          ; data
  2202                          
  2203                          ; instruction textual mnuemonic first, second, third letters (read down in source)
  2204                          ninst = 56
  2205  8c37 4141414242424242...inst0 !text "AAABBBBBBBBBBCCCCCCCDDDEIIIJJLLLLNOPPPPRRRRSSSSSSSTTTTTT"
  2206  8c6f 444e53434345494d...inst1 !text "DNSCCEIMNPRVVLLLLMPPEEEONNNMSDDDSORHHLLOOTTBEEETTTAASXXY"
  2207  8ca7 43444c4353515449...inst2 !text "CDLCSQTIELKCSCDIVPXYCXYRCXYPRAXYRPAAPAPLRISCCDIAXYXYXASA"
  2208                          
  2209                          ; 6502 addressing modes by index number and number of bytes per instruction shown at end of comment
  2210                          mode_jmptable:
  2211  8cdf 4d82               !word dispModeAcc-1; 0 Accumulator 1
  2212  8ce1 5282               !word dispModeNone-1 ; 1 None 1
  2213  8ce3 5382               !word dispModeImm-1 ; 2 Immediate 2
  2214  8ce5 6482               !word dispModeIndX-1 ; 3 IndirectX 2
  2215  8ce7 8482               !word dispModeIndY-1 ; 4 IndirectY 2
  2216  8ce9 a482               !word dispModeRel-1 ; 5 Relative 2
  2217  8ceb 5882               !word dispModeZP-1 ; 6 ZeroPage 2
  2218  8ced e082               !word dispModeZPX-1 ; 7 ZeroPageX 2
  2219  8cef ed82               !word dispModeZPY-1 ; 8 ZeroPageY 2
  2220  8cf1 fa82               !word dispModeAbs-1 ; 9 Absolute 3
  2221  8cf3 0c83               !word dispModeAbsX-1 ; 10 AbsoluteX 3
  2222  8cf5 1983               !word dispModeAbsY-1 ; 11 AbsoluteY 3
  2223  8cf7 2683               !word dispModeInd-1 ; 12 Indirect 3
  2224                          
  2225                          nmodes = 13
  2226                          
  2227                          mode_sorted:
  2228  8cf9 090a0b00020c0304...!byte 9, 10, 11, 0, 2, 12, 3, 4, 1, 5, 6, 7, 8
  2229                          
  2230                          !ifdef MINIMUM {
  2231                          mode_0: !text "Accumulator", 0, "A", 0
  2232                          mode_1: !text "None", 0, 8, 0
  2233                          mode_2: !text "Immediate", 0, "#$12", 0
  2234                          mode_3: !text "IndirectX", 0, "($12,X)", 0
  2235                          mode_4: !text "IndirectY", 0, "($12),Y", 0
  2236                          mode_5: !text "Relative", 0, "$1234 {-128 to +127}", 0
  2237                          mode_6: !text "ZeroPage", 0, "$12", 0
  2238                          mode_7: !text "ZeroPageX", 0, "$12,X", 0
  2239                          mode_8: !text "ZeroPageY", 0, "$12,Y", 0
  2240                          mode_9: !text "Absolute", 0, "$1234", 0
  2241                          mode_10: !text "AbsoluteX", 0, "$1234,X", 0
  2242                          mode_11: !text "AbsoluteY", 0, "$1234,Y", 0
  2243                          mode_12: !text "Indirect", 0, "($1234)", 0
  2244                          } else {
  2245  8d06 414343554d554c41...mode_0: !text "ACCUMULATOR", 0, "A", 0
  2246  8d14 4e4f4e45001400     mode_1: !text "NONE", 0, 20, 0
  2247  8d1b 494d4d4544494154...mode_2: !text "IMMEDIATE", 0, "#$12", 0
  2248  8d2a 494e444952454354...mode_3: !text "INDIRECTX", 0, "($12,X)", 0
  2249  8d3c 494e444952454354...mode_4: !text "INDIRECTY", 0, "($12),Y", 0
  2250  8d4e 52454c4154495645...mode_5: !text "RELATIVE", 0, "$1234", 146, " [-128 TO +127]", 0
  2251  8d6d 5a45524f50414745...mode_6: !text "ZEROPAGE", 0, "$12", 0
  2252  8d7a 5a45524f50414745...mode_7: !text "ZEROPAGEX", 0, "$12,X", 0
  2253  8d8a 5a45524f50414745...mode_8: !text "ZEROPAGEY", 0, "$12,Y", 0
  2254  8d9a 4142534f4c555445...mode_9: !text "ABSOLUTE", 0, "$1234", 0
  2255  8da9 4142534f4c555445...mode_10: !text "ABSOLUTEX", 0, "$1234,X", 0
  2256  8dbb 4142534f4c555445...mode_11: !text "ABSOLUTEY", 0, "$1234,Y", 0
  2257  8dcd 494e444952454354...mode_12: !text "INDIRECT", 0, "($1234)", 0
  2258                          }
  2259                          
  2260                          modes: ; table for easily displaying each mode_example
  2261  8dde 068d               !word mode_0
  2262  8de0 148d               !word mode_1
  2263  8de2 1b8d               !word mode_2
  2264  8de4 2a8d               !word mode_3
  2265  8de6 3c8d               !word mode_4
  2266  8de8 4e8d               !word mode_5
  2267  8dea 6d8d               !word mode_6
  2268  8dec 7a8d               !word mode_7
  2269  8dee 8a8d               !word mode_8
  2270  8df0 9a8d               !word mode_9
  2271  8df2 a98d               !word mode_10
  2272  8df4 bb8d               !word mode_11
  2273  8df6 cd8d               !word mode_12
  2274                          
  2275                          ; opcode table of byte values (opcodes), instructions, and addressing modes
  2276                          nopcodes = 151
  2277  8df8 0001050608090a0d...opcodes !byte $00,$01,$05,$06,$08,$09,$0A,$0D,$0E,$10,$11,$15,$16,$18,$19,$1D,$1E,$20,$21,$24,$25,$26,$28,$29,$2A,$2C,$2D,$2E,$30,$31,$35,$36,$38,$39,$3D,$3E,$40,$41,$45,$46,$48,$49,$4A,$4C,$4D,$4E,$50,$51,$55,$56,$58,$59,$5D,$5E,$60,$61,$65,$66,$68,$69,$6A,$6C,$6D,$6E,$70,$71,$75,$76,$78,$79,$7D,$7E,$81,$84,$85,$86,$88,$8A,$8C,$8D,$8E,$90,$91,$94,$95,$96,$98,$99,$9A,$9D,$A0,$A1,$A2,$A4,$A5,$A6,$A8,$A9,$AA,$AC,$AD,$AE,$B0,$B1,$B4,$B5,$B6,$B8,$B9,$BA,$BC,$BD,$BE,$C0,$C1,$C4,$C5,$C6,$C8,$C9,$CA,$CC,$CD,$CE,$D0,$D1,$D5,$D6,$D8,$D9,$DD,$DE,$E0,$E1,$E4,$E5,$E6,$E8,$E9,$EA,$EC,$ED,$EE,$F0,$F1,$F5,$F6,$F8,$F9,$FD,$FE
  2278  8e8f 0a22220224220222...instidx !byte $0A,$22,$22,$02,$24,$22,$02,$22,$02,$09,$22,$22,$02,$0D,$22,$22,$02,$1C,$01,$06,$01,$27,$26,$01,$27,$06,$01,$27,$07,$01,$01,$27,$2C,$01,$01,$27,$29,$17,$17,$20,$23,$17,$20,$1B,$17,$20,$0B,$17,$17,$20,$0F,$17,$17,$20,$2A,$00,$00,$28,$25,$00,$28,$1B,$00,$28,$0C,$00,$00,$28,$2E,$00,$00,$28,$2F,$31,$2F,$30,$16,$35,$31,$2F,$30,$03,$2F,$31,$2F,$30,$37,$2F,$36,$2F,$1F,$1D,$1E,$1F,$1D,$1E,$33,$1D,$32,$1F,$1D,$1E,$04,$1D,$1F,$1D,$1E,$10,$1D,$34,$1F,$1D,$1E,$13,$11,$13,$11,$14,$1A,$11,$15,$13,$11,$14,$08,$11,$11,$14,$0E,$11,$11,$14,$12,$2B,$12,$2B,$18,$19,$2B,$21,$12,$2B,$18,$05,$2B,$2B,$18,$2D,$2B,$2B,$18
  2279  8f26 0103060601020009...modeidx !byte $01,$03,$06,$06,$01,$02,$00,$09,$09,$05,$04,$07,$07,$01,$0B,$0A,$0A,$09,$03,$06,$06,$06,$01,$02,$00,$09,$09,$09,$05,$04,$07,$07,$01,$0B,$0A,$0A,$01,$03,$06,$06,$01,$02,$00,$09,$09,$09,$05,$04,$07,$07,$01,$0B,$0A,$0A,$01,$03,$06,$06,$01,$02,$00,$0C,$09,$09,$05,$04,$07,$07,$01,$0B,$0A,$0A,$03,$06,$06,$06,$01,$01,$09,$09,$09,$05,$04,$07,$07,$08,$01,$0B,$01,$0A,$02,$03,$02,$06,$06,$06,$01,$02,$01,$09,$09,$09,$05,$04,$07,$07,$08,$01,$0B,$01,$0A,$0A,$0B,$02,$03,$06,$06,$06,$01,$02,$01,$09,$09,$09,$05,$04,$07,$07,$01,$0B,$0A,$0A,$02,$03,$06,$06,$06,$01,$02,$01,$09,$09,$09,$05,$04,$07,$07,$01,$0B,$0A,$0A
  2280                          
  2281                          copyright 
  2282                          ;                  1         2         3         4
  2283                          ;         1234567890123456789012345678901234567890
  2284  8fbd 0d36353032204d4f...!text 13,"6502 MONITOR AND MINI-ASSEMBLER"
  2285                          !ifdef C64TERMINAL {
  2286                              !text 13, "(TERMINAL VERSION)"
  2287                          }
  2288  8fdd 0d56574153363530...!text 13,"VWAS6502 (C) 2024 DAVID R. VAN WAGNER"
  2289  9003 0d4d4954204c4943...!text 13, "MIT LICENSE DAVEVW.COM"
  2290  901a 00                 !text 0
  2291                          
  2292                          firsthelp
  2293                          ;!text 13, "? KEYWORD FOR EXAMPLE(S)"
  2294  901b 0d0d               !text 13, 13
  2295  901d 54595045203f2046...!text "TYPE ? FOR HELP"
  2296  902c 0d00               !text 13, 0
  2297                          
  2298                          !ifndef MINIMUM {
  2299                          ; C64 only
  2300                          extra_help:
  2301  902e 5820202020202020...    !text "X           (EXIT MONITOR)", 13
  2302  9049 313030302e323030...    !text "1000.2000 ", 34, "FILENAME", 34, " 08 S  (SAVE)", 13
  2303  906b 00                     !text 0
  2304                          
  2305                          !ifdef C64SCREEN {
  2306  906c 449d9d9d9d9d00     page_disassemble !text "D",157,157,157,157,157,0
  2307  9073 2e9d9d9d9d9d00     page_displaymemory !text ".",157,157,157,157,157,0
  2308                          }
  2309                          
  2310                          }
  2311                          
  2312  907a 4e4f5420494d504c...notimplemented !text "NOT IMPLEMENTED",13,0
  2313                          
  2314                          generalhelp
  2315  908b 3130303020202020...!text "1000        (DISPLAY MEMORY CONTENTS)",13
  2316  90b1 313030302e313030...!text "1000.100F   (DISPLAY RANGE CONTENTS)", 13
  2317  90d6 313030302e202020...!text "1000.       (SCREENFULL OF MEMORY)", 13
  2318  90f9 2e20202020202020...!text ".           (NEXT SCREENFULL OF MEMORY)", 13
  2319  9121 313030303a203031...!text "1000: 01 02 (MODIFY MEMORY)", 13
  2320  913d 3130303020522020...!text "1000 R      (RUN PROGRAM - JMP)", 13
  2321  915d 3130303020412020...!text "1000 A      (ASSEMBLE AT ADDRESS)", 13
  2322  917f 00                 !text 0
  2323                          generalhelp2
  2324  9180 3130303020442020...!text "1000 D      (DISASSEMBLE AT ADDRESS)", 13
  2325  91a5 4120202020202020...!text "A           (ASSEMBLE MORE)", 13
  2326  91c1 4420202020202020...!text "D           (DISASSEMBLE MORE)", 13
  2327  91e0 3f20412020202020...!text "? A         (LIST 6502 INSTRUCTIONS)", 13
  2328  9205 3f20414443202020...!text "? ADC       (/ADC/ ADDRESSING MODES)", 13
  2329  922a 3f204d4f44452020...!text "? MODE      (ADDRESSING MODES)", 13
  2330  9249 3f2e202020202020...!text "?.          (DISPLAY REGISTERS)", 13
  2331  9269 00                 !text 0
  2332                          
  2333  926a 4d4f444500         modes_keyword !text "MODE", 0
  2334                          
  2335  926f 2050432020204e56...reg_header !text " PC   NV-BDIZC .A .X .Y .S", 13, '.', 0
  2336                          
  2337                          !ifdef MINIMUM {
  2338                          registerA = $def9
  2339                          registerX = $defa
  2340                          registerY = $defb
  2341                          registerSP = $defc
  2342                          registerSR = $defd
  2343                          registerPC = $defe;/f
  2344                          savestack = $df00
  2345                          } else {
  2346  928c 0000               savebrkvector !word 0
  2347  928e 0000               savenmivector !word 0
  2348  9290 00                 drive !byte 0
  2349  9291 00                 registerA !byte 0
  2350  9292 00                 registerX !byte 0
  2351  9293 00                 registerY !byte 0
  2352  9294 00                 registerSP !byte 0
  2353  9295 00                 registerSR !byte 0
  2354  9296 0000               registerPC !word 0
  2355                          savestack ; 256 bytes
  2356  9298 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2357  92a8 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2358  92b8 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2359  92c8 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2360  92d8 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2361  92e8 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2362  92f8 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2363  9308 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2364  9318 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2365  9328 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2366  9338 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2367  9348 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2368  9358 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2369  9368 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2370  9378 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2371  9388 0000000000000000...!byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  2372                          }
  2373                          
  2374                          !ifdef MINIMUM {
  2375                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  2376                          ; JUMP table for some stability
  2377                          * = $FFEE
  2378                          JUART_INIT: JMP UART_INIT
  2379                          JUART_OUT: JMP UART_OUT
  2380                          JUART_IN: JMP UART_IN
  2381                          JUART_CHK: JMP UART_CHK
  2382                          
  2383                          ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  2384                          ; 6502 vectors 
  2385                          * = $fffa
  2386                              !word NMI
  2387                              !word RESET
  2388                              !word IRQ
  2389                          } else { // C64
  2390                              !if * > $a000 {
  2391                                  !error "code/data overran $a000"
  2392                              }
  2393                          }
  2394                          
  2395                          finish = *
